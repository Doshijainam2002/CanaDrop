<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard ‚Ä¢ CanaLogistiX</title>
  <link rel="icon" href="https://canalogistix.s3.us-east-2.amazonaws.com/Logo/CanaLogistiX_Logo_BG.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .logistics-bg {
      background:
        linear-gradient(135deg, rgba(255,255,255,0.04) 25%, rgba(0,0,0,0) 25%) 0 0/28px 28px,
        linear-gradient(135deg, rgba(0,0,0,0) 75%, rgba(255,255,255,0.04) 75%) 0 0/28px 28px;
      box-shadow: inset 0 0 120px rgba(0,0,0,0.35);
    }
  </style>
</head>
<body class="min-h-screen bg-neutral-900 text-neutral-100 font-inter logistics-bg">

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-neutral-800 border-r border-neutral-700 flex flex-col fixed lg:static inset-y-0 left-0 z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 overflow-y-auto">
      <div class="flex items-center h-16 border-b border-neutral-700 px-6">
        <img src="https://canalogistix.s3.us-east-2.amazonaws.com/Logo/CanaLogistiX_Logo_BG.png" alt="CanaLogistiX Logo" class="h-12 w-12 rounded-full object-cover"/>
        <span class="ml-2 text-lg font-semibold text-white">CanaLogistiX</span>
      </div>


      <!-- Navigation -->
      <nav class="flex-1 p-4 space-y-2 text-sm overflow-y-auto">
        <a href="/adminDashboard/" class="flex items-center px-3 py-2 rounded-lg bg-gradient-to-r from-orange-600 to-orange-500 text-white font-medium">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M13 5v6h6"/></svg>
          Dashboard
        </a>
        <a href="/adminOrders/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm6 0v-8a2 2 0 00-2-2h-2a2 2 0 00-2 2v8m6 0a2 2 0 002 2h2a2 2 0 002-2"/></svg>
          Orders
        </a>
        <a href="/adminPharmacies/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V5a3 3 0 00-3-3H7a3 3 0 00-3 3v6m12 0v6a3 3 0 01-3 3H7a3 3 0 01-3-3v-6m12 0H4"/></svg>
          Pharmacies
        </a>
        <a href="/adminDrivers/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          Drivers
        </a>
        <a href="/adminInvoices/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 4H7a2 2 0 01-2-2V6a2 2 0 012-2h7l5 5v9a2 2 0 01-2 2z"/></svg>
          Invoices
        </a>
        <a href="/adminSupport/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8s-9-3.582-9-8 4.03-8 9-8 9 3.582 9 8zM12 14v-4m0 4h.01"/></svg>
          Support
        </a>
        <a href="#" 
        id="logoutBtn"
        class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h6a2 2 0 012 2v1" />
            </svg>
            Logout
        </a>

      </nav>

      <!-- Profile -->
      <div class="p-4 border-t border-neutral-700">
        <div class="flex items-center">
          <div class="flex-shrink-0 w-9 h-9 bg-gradient-to-r from-orange-600 to-orange-500 rounded-full flex items-center justify-center text-sm font-semibold">A</div>
          <div class="ml-3">
            <p class="text-sm font-medium text-neutral-100">Admin</p>
            <p class="text-xs text-neutral-400">admin@canadrop.ca</p>
          </div>
        </div>
      </div>
    </aside>

    <div id="sidebarOverlay" class="hidden lg:hidden fixed inset-0 bg-black/50 z-30"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-y-auto lg:ml-0">
      <!-- Header -->
      <header class="bg-neutral-800 border-b border-neutral-700 px-4 sm:px-6 py-4 flex items-center justify-between gap-4">
        <button id="menuToggle" class="lg:hidden text-white p-2 flex-shrink-0">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
        <div class="flex-1 min-w-0">
          <h1 class="text-xl sm:text-2xl font-bold text-white truncate">Admin Dashboard</h1>
          <p class="text-sm text-neutral-400">Manage system-wide operations and insights</p>
        </div>
      </header>

        <!-- Summary Cards -->
        <section class="px-4 sm:px-6 py-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6">
        <!-- Total Pharmacies -->
        <div class="bg-neutral-800/80 border border-neutral-700 p-6 rounded-xl shadow">
            <p class="text-sm text-neutral-400">Total Pharmacies</p>
            <p id="statTotalPharmacies" class="text-2xl font-bold text-white mt-1">‚Äî</p>
        </div>

        <!-- Total Drivers -->
        <div class="bg-neutral-800/80 border border-neutral-700 p-6 rounded-xl shadow">
            <p class="text-sm text-neutral-400">Total Drivers</p>
            <p id="statTotalDrivers" class="text-2xl font-bold text-white mt-1">‚Äî</p>
        </div>

        <!-- Active Orders -->
        <div class="bg-neutral-800/80 border border-neutral-700 p-6 rounded-xl shadow">
            <p class="text-sm text-neutral-400">Active Orders</p>
            <p id="statActiveOrders" class="text-2xl font-bold text-white mt-1">‚Äî</p>
        </div>

        <!-- Monthly Revenue -->
        <div class="bg-neutral-800/80 border border-neutral-700 p-6 rounded-xl shadow">
            <p class="text-sm text-neutral-400">Revenue (This Month)</p>
            <p id="statRevenue" class="text-2xl font-bold text-white mt-1">‚Äî</p>
        </div>

        <!-- Driver Payouts -->
        <div class="bg-neutral-800/80 border border-neutral-700 p-6 rounded-xl shadow">
            <p class="text-sm text-neutral-400">Driver Payouts (This Month)</p>
            <p id="statDriverPayouts" class="text-2xl font-bold text-white mt-1">‚Äî</p>
        </div>
        </section>


      <!-- 3-column insights section -->
      <section class="px-4 sm:px-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-8">

        <!-- Recent Activity Feed -->
        <div id="recentActivity" class="bg-neutral-800/80 border border-neutral-700 rounded-xl p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-white">Recent Activity Feed</h2>
            <button id="refreshRecentActivityBtn"
            class="px-3 py-1 text-xs rounded-lg border border-neutral-600 text-neutral-300 hover:bg-neutral-700">
            Refresh
            </button>
        </div>

        <!-- status / errors -->
        <p id="recentActivityStatus" class="text-xs text-neutral-400 hidden">Loading‚Ä¶</p>

        <ul id="recentActivityList" class="space-y-4 text-sm">
            <!-- JS will render items here -->
        </ul>
        </div>


        <!-- üß≠ Order Tracking Manager -->
        <div class="bg-neutral-800/80 border border-neutral-700 rounded-xl p-6">
        <div class="flex flex-col gap-3 mb-4">
          <h2 class="text-lg font-semibold text-white">Order Tracking Manager</h2>
          <input
            id="orderSearch"
            type="text"
            placeholder="Search by Order ID, Pharmacy, or Driver..."
            class="px-3 py-2 bg-neutral-700 text-neutral-200 text-sm rounded-md w-full focus:outline-none focus:ring-2 focus:ring-amber-500"
          />
        </div>

        <div id="ordersContainer" class="overflow-y-auto max-h-80 divide-y divide-neutral-700">
            <!-- Orders will be dynamically populated here -->
        </div>

        <!-- Pagination Controls -->
        <div class="flex justify-center items-center space-x-3 mt-4">
            <button
            id="prevPage"
            class="px-3 py-1.5 bg-neutral-700 text-neutral-300 rounded-md text-sm hover:bg-neutral-600 disabled:opacity-40"
            >
            ‚Üê Prev
            </button>
            <span id="pageInfo" class="text-neutral-400 text-sm">Page 1</span>
            <button
            id="nextPage"
            class="px-3 py-1.5 bg-neutral-700 text-neutral-300 rounded-md text-sm hover:bg-neutral-600 disabled:opacity-40"
            >
            Next ‚Üí
            </button>
        </div>

        <p class="text-xs text-neutral-500 mt-3 text-center">
            Click any order to view timeline and proof images
        </p>
        </div>

        <!-- üîç Modal for Order Details -->
        <div id="orderModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-neutral-900 p-6 rounded-xl border border-neutral-700 w-11/12 max-h-[90vh] overflow-y-auto md:w-2/3 lg:w-1/2 relative">
            <button
            id="closeModal"
            class="absolute top-3 right-3 text-neutral-400 hover:text-white text-xl font-bold"
            >&times;</button>

            <h3 id="modalTitle" class="text-lg font-semibold text-white mb-2">Order Details</h3>
            <p id="modalSubTitle" class="text-sm text-neutral-400 mb-4"></p>

            <div id="modalTimeline" class="space-y-3 text-sm text-neutral-300 mb-4">
            <!-- Timeline goes here -->
            </div>

            <div id="modalProofs" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <!-- Proof Images -->
            </div>
        </div>
        </div>


        <!-- ‚ö†Ô∏è Alerts Section -->
        <div class="bg-neutral-800/80 border border-neutral-700 rounded-xl p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-white">Alerts</h2>
            <button
            id="refreshAlerts"
            class="px-3 py-1.5 bg-neutral-700 text-neutral-300 text-xs rounded hover:bg-neutral-600 transition"
            >
            Refresh
            </button>
        </div>

        <!-- Alert summary counts -->
        <div id="alertSummary" class="grid grid-cols-3 gap-2 md:gap-3 lg:gap-4 mb-4 text-center">
            <div class="bg-neutral-700/50 border border-neutral-700 rounded-lg p-2 sm:p-3">
              <p class="text-xs text-neutral-400 uppercase truncate">Operational</p>
              <p id="countOperational" class="text-lg sm:text-xl font-semibold text-yellow-400">0</p>
            </div>
            <div class="bg-neutral-700/50 border border-neutral-700 rounded-lg p-2 sm:p-3">
              <p class="text-xs text-neutral-400 uppercase truncate">Financial</p>
              <p id="countFinancial" class="text-lg sm:text-xl font-semibold text-red-400">0</p>
            </div>
            <div class="bg-neutral-700/50 border border-neutral-700 rounded-lg p-2 sm:p-3">
              <p class="text-xs text-neutral-400 uppercase truncate">Support</p>
              <p id="countSupport" class="text-lg sm:text-xl font-semibold text-orange-400">0</p>
            </div>
        </div>

        <!-- Alert List -->
        <ul id="alertsContainer" class="space-y-3 text-sm">
            <!-- Alerts will be dynamically populated -->
            <li class="text-neutral-400 text-center py-4">Loading alerts...</li>
        </ul>
        </div>

      </section>

    <!-- Recent Orders Table -->
    <section class="px-4 sm:px-6 pb-10">
    <div class="bg-neutral-800/80 border border-neutral-700 rounded-xl shadow">
        <div class="px-6 py-4 border-b border-neutral-700 flex justify-between items-center">
        <h2 class="text-lg font-semibold text-white">Recent Orders</h2>
        <select
            id="statusFilter"
            class="text-sm bg-neutral-800 border border-neutral-700 rounded-lg px-3 py-1 text-neutral-300 focus:ring-2 focus:ring-orange-500 focus:outline-none"
        >
            <option value="All">All Status</option>
            <option value="pending">Pending</option>
            <option value="accepted">Accepted</option>
            <option value="picked_up">Picked Up</option>
            <option value="inTransit">In Transit</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
        </select>
        </div>

        <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
            <thead class="bg-neutral-800 border-b border-neutral-700">
            <tr>
                <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">
                Order ID
                </th>
                <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">
                Pharmacy
                </th>
                <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">
                Driver
                </th>
                <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">
                Status
                </th>
                <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">
                Amount
                </th>
            </tr>
            </thead>
            <tbody id="recentOrdersTableBody" class="divide-y divide-neutral-700">
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-neutral-500">
                Loading recent orders...
                </td>
            </tr>
            </tbody>
        </table>
        </div>
    </div>
    </section>


      <script>

          // Formatters
  const fmtInt = n => new Intl.NumberFormat().format(Number(n || 0));
  const fmtCAD = n => new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', maximumFractionDigits: 2 }).format(Number(n || 0));

  async function loadAdminDashboardStats() {
    const els = {
      pharm: document.getElementById('statTotalPharmacies'),
      drivers: document.getElementById('statTotalDrivers'),
      active: document.getElementById('statActiveOrders'),
      revenue: document.getElementById('statRevenue'),
      payouts: document.getElementById('statDriverPayouts'),
    };

    // quick skeleton placeholders
    Object.values(els).forEach(el => el && (el.textContent = '‚Ä¶'));

    try {
      const res = await fetch('/api/adminDashboardStats/', { method: 'GET' });
      if (!res.ok) throw new Error('Network error');
      const { success, metrics } = await res.json();
      if (!success) throw new Error('API returned error');

      els.pharm.textContent   = fmtInt(metrics.total_pharmacies);
      els.drivers.textContent = fmtInt(metrics.total_drivers);
      els.active.textContent  = fmtInt(metrics.active_orders);
      els.revenue.textContent = fmtCAD(metrics.revenue_this_month);
      els.payouts.textContent = fmtCAD(metrics.driver_payout_this_month);
    } catch (err) {
      console.error('Failed to load dashboard stats:', err);
      // graceful fallback
      els.pharm.textContent   = '0';
      els.drivers.textContent = '0';
      els.active.textContent  = '0';
      els.revenue.textContent = fmtCAD(0);
      els.payouts.textContent = fmtCAD(0);
    }
  }

  document.addEventListener('DOMContentLoaded', loadAdminDashboardStats);


    const typeDotClass = {
    "Order": "bg-orange-500",
    "Pharmacy Invoice": "bg-yellow-500",
    "Driver Invoice": "bg-amber-500",
    "New Pharmacy": "bg-green-500",
    "New Driver": "bg-cyan-500",
    "Support Ticket": "bg-red-500",
  };

  // Utility: escape HTML
  function esc(str) {
    return String(str ?? "").replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[m]));
  }

  // Optional: nice short time (e.g., "2025-11-09 14:22")
  function fmt(ts) {
    try {
      const d = new Date(ts);
      const pad = n => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    } catch { return ts; }
  }

  async function loadRecentActivity() {
    const listEl = document.getElementById("recentActivityList");
    const statusEl = document.getElementById("recentActivityStatus");

    if (!listEl || !statusEl) return;

    statusEl.classList.remove("hidden");
    statusEl.textContent = "Loading‚Ä¶";
    listEl.innerHTML = "";

    try {
      const res = await fetch("/api/recentActivityFeed/");
      if (!res.ok) throw new Error("Network response was not ok");
      const data = await res.json();

      if (!data.success) throw new Error(data.error || "Unknown error");

      const items = data.recent_activity || [];

      if (items.length === 0) {
        listEl.innerHTML = `
          <li class="text-neutral-400 text-sm">No recent activity.</li>
        `;
        statusEl.classList.add("hidden");
        return;
      }

      const frag = document.createDocumentFragment();

      items.forEach(item => {
        const dotClass = typeDotClass[item.type] || "bg-orange-500";
        const li = document.createElement("li");
        li.className = "flex items-start";

        li.innerHTML = `
          <span class="w-2 h-2 mt-1.5 ${dotClass} rounded-full mr-3"></span>
          <p class="leading-snug">
            <span class="font-semibold text-orange-400">${esc(item.type)}</span>:
            <span class="text-neutral-200">${esc(item.title)}</span>
            ${item.description ? ` ‚Äî <span class="text-neutral-400">${esc(item.description)}</span>` : ""}
            <span class="block text-xs text-neutral-500 mt-0.5">${fmt(item.timestamp)}</span>
          </p>
        `;
        frag.appendChild(li);
      });

      listEl.appendChild(frag);
      statusEl.classList.add("hidden");
    } catch (err) {
      listEl.innerHTML = `
        <li class="text-red-400 text-sm">Failed to load recent activity.</li>
      `;
      statusEl.classList.remove("hidden");
      statusEl.textContent = "Error loading feed.";
      console.error("Recent Activity Feed error:", err);
    }
  }

  // Wire up refresh button + initial load
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("refreshRecentActivityBtn");
    if (btn) btn.addEventListener("click", loadRecentActivity);

    loadRecentActivity();
    // Optional auto-refresh every 60s:
    // setInterval(loadRecentActivity, 60000);
  });




let allOrders = [];
let filteredOrders = [];
let currentPage = 1;
const ordersPerPage = 8;

// üßæ Load and initialize
async function loadOrders() {
  try {
    const response = await fetch("/api/orderTrackingOverview/");
    const data = await response.json();
    if (!data.success) throw new Error("Failed to load orders");

    allOrders = data.orders;
    filteredOrders = [...allOrders];
    currentPage = 1;
    renderOrders();

    // ‚úÖ NEW: Render the Recent Orders Table
    renderRecentOrdersTable(allOrders);
  } catch (error) {
    console.error(error);
    document.getElementById("ordersContainer").innerHTML =
      '<p class="text-center text-neutral-500 py-6">Failed to load order data.</p>';
    document.getElementById("recentOrdersTableBody").innerHTML =
      '<tr><td colspan="5" class="px-6 py-4 text-center text-neutral-500">Failed to load recent orders.</td></tr>';
  }
}

// üß≠ Render paginated orders
function renderOrders() {
  const container = document.getElementById("ordersContainer");
  const pageInfo = document.getElementById("pageInfo");
  const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);

  if (!filteredOrders.length) {
    container.innerHTML =
      '<p class="text-center text-neutral-500 py-6">No orders found.</p>';
    pageInfo.innerText = "No pages";
    document.getElementById("prevPage").disabled = true;
    document.getElementById("nextPage").disabled = true;
    return;
  }

  const start = (currentPage - 1) * ordersPerPage;
  const end = start + ordersPerPage;
  const visibleOrders = filteredOrders.slice(start, end);

  container.innerHTML = visibleOrders
    .map(
      (o) => `
      <div
        class="p-3 hover:bg-neutral-700/40 cursor-pointer transition"
        onclick="openOrderModal(${o.order_id})"
      >
        <div class="flex justify-between items-center">
          <div>
            <p class="font-semibold text-white">Order #${o.order_id}</p>
            <p class="text-xs text-neutral-400">
              ${o.pharmacy.name} ‚Üí ${o.drop_city} (${o.status})
            </p>
          </div>
          <p class="text-sm text-amber-400">${o.driver ? o.driver.name : "Unassigned"}</p>
        </div>
      </div>`
    )
    .join("");

  pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
  document.getElementById("prevPage").disabled = currentPage === 1;
  document.getElementById("nextPage").disabled = currentPage === totalPages;
}

// üîç Search filter (resets to page 1)
document.getElementById("orderSearch").addEventListener("input", (e) => {
  const query = e.target.value.toLowerCase();
  filteredOrders = allOrders.filter(
    (o) =>
      o.order_id.toString().includes(query) ||
      o.pharmacy.name.toLowerCase().includes(query) ||
      (o.driver && o.driver.name.toLowerCase().includes(query))
  );
  currentPage = 1;
  renderOrders();
});

// ‚óÄÔ∏è Prev / Next controls
document.getElementById("prevPage").addEventListener("click", () => {
  if (currentPage > 1) {
    currentPage--;
    renderOrders();
  }
});
document.getElementById("nextPage").addEventListener("click", () => {
  const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
  if (currentPage < totalPages) {
    currentPage++;
    renderOrders();
  }
});

// ü™ü Modal handling
function openOrderModal(orderId) {
  const order = allOrders.find((o) => o.order_id === orderId);
  if (!order) return;

  document.getElementById("modalTitle").innerText = `Order #${order.order_id}`;
  document.getElementById(
    "modalSubTitle"
  ).innerText = `${order.pharmacy.name} ‚Üí ${order.drop_city} (${order.status})`;

  // Timeline
  document.getElementById("modalTimeline").innerHTML =
    order.tracking_history.length
      ? order.tracking_history
          .map(
            (t) => `
            <div class="border-l-2 border-amber-500 pl-3">
              <p class="text-neutral-100 font-medium">${t.step}</p>
              <p class="text-xs text-neutral-400">${t.performed_by} ‚Ä¢ ${new Date(
              t.timestamp
            ).toLocaleString()}</p>
              ${
                t.note
                  ? `<p class="text-xs text-neutral-500 italic mt-1">${t.note}</p>`
                  : ""
              }
            </div>`
          )
          .join("")
      : "<p class='text-neutral-500 text-sm'>No tracking events.</p>";

  // Proofs
  document.getElementById("modalProofs").innerHTML =
    order.proof_images.length
      ? order.proof_images
          .map(
            (img) => `
            <div>
              <img src="${img.image_url}" alt="${img.stage}" class="rounded-lg w-full h-32 object-cover border border-neutral-700" />
              <p class="text-xs text-neutral-400 mt-1 text-center">${img.stage}</p>
            </div>`
          )
          .join("")
      : "<p class='text-neutral-500 text-sm'>No proof images.</p>";

  document.getElementById("orderModal").classList.remove("hidden");
}

document.getElementById("closeModal").addEventListener("click", () => {
  document.getElementById("orderModal").classList.add("hidden");
});

document.addEventListener("DOMContentLoaded", loadOrders);


// üÜï NEW SECTION: RECENT ORDERS TABLE RENDERER
function renderRecentOrdersTable(allOrders) {
  const tbody = document.getElementById("recentOrdersTableBody");
  const statusFilter = document.getElementById("statusFilter");
  if (!tbody) return;

  // Sort by created_at descending
  let recentOrders = [...allOrders].sort(
    (a, b) => new Date(b.created_at) - new Date(a.created_at)
  );

  // Only keep top 8
  recentOrders = recentOrders.slice(0, 8);

  // Render function
  const render = (orders) => {
    if (!orders.length) {
      tbody.innerHTML =
        '<tr><td colspan="5" class="px-6 py-4 text-center text-neutral-500">No recent orders found.</td></tr>';
      return;
    }

    tbody.innerHTML = orders
      .map((o) => {
        // Dynamic status badge color
        let color = "orange";
        if (o.status === "delivered") color = "green";
        else if (o.status === "pending") color = "yellow";
        else if (o.status === "cancelled") color = "red";
        else if (o.status === "inTransit") color = "amber";
        else if (o.status === "picked_up") color = "blue";

        return `
          <tr class="hover:bg-neutral-700/50 transition">
            <td class="px-6 py-4 text-neutral-100 font-medium">#${o.order_id}</td>
            <td class="px-6 py-4 text-neutral-300">${o.pharmacy.name}</td>
            <td class="px-6 py-4 text-neutral-300">${
              o.driver ? o.driver.name : "Unassigned"
            }</td>
            <td class="px-6 py-4">
              <span class="inline-flex px-3 py-1 text-xs font-medium rounded-full bg-${color}-500/20 text-${color}-400 border border-${color}-600/40">
                ${o.status}
              </span>
            </td>
            <td class="px-6 py-4 text-neutral-100 font-semibold">$${parseFloat(
              o.rate || 0
            ).toFixed(2)}</td>
          </tr>
        `;
      })
      .join("");
  };

  // Initial render
  render(recentOrders);

  // Filter handler
  statusFilter.addEventListener("change", (e) => {
    const value = e.target.value.toLowerCase();
    const filtered =
      value === "all"
        ? recentOrders
        : recentOrders.filter((o) => o.status.toLowerCase() === value);
    render(filtered);
  });
}


async function loadAlerts() {
  const container = document.getElementById("alertsContainer");
  const summary = {
    operational: document.getElementById("countOperational"),
    financial: document.getElementById("countFinancial"),
    support: document.getElementById("countSupport"),
  };

  try {
    container.innerHTML = '<li class="text-neutral-400 text-center py-4">Loading...</li>';

    const response = await fetch("/api/adminAlerts/");
    const data = await response.json();

    if (!data.success) throw new Error("Failed to fetch alerts");

    // Update summary counts
    summary.operational.textContent = data.categories.operational;
    summary.financial.textContent = data.categories.financial;
    summary.support.textContent = data.categories.support;

    const alerts = [
      ...data.alerts.operational.map((a) => ({ ...a, category: "operational" })),
      ...data.alerts.financial.map((a) => ({ ...a, category: "financial" })),
      ...data.alerts.support.map((a) => ({ ...a, category: "support" })),
    ];

    if (!alerts.length) {
      container.innerHTML =
        '<li class="text-neutral-400 text-center py-4">‚úÖ All systems normal ‚Äî no active alerts.</li>';
      return;
    }

    // Render alerts list
    container.innerHTML = alerts
      .map((a) => {
        let color = "yellow";
        let icon = "‚ö†";
        if (a.category === "financial") {
          color = "red";
          icon = "üí∞";
        } else if (a.category === "support") {
          color = "orange";
          icon = "üì®";
        }

        return `
          <li class="flex items-start bg-neutral-800 border-l-4 border-${color}-500 p-3 rounded hover:bg-neutral-700/50 transition">
            <span class="text-${color}-400 mr-2">${icon}</span>
            <div>
              <p class="text-neutral-200">
                <strong>${a.type}</strong> ‚Äî ${a.message}
              </p>
              <p class="text-xs text-neutral-500 mt-1">${new Date(
                a.timestamp
              ).toLocaleString()}</p>
            </div>
          </li>
        `;
      })
      .join("");
  } catch (error) {
    console.error(error);
    container.innerHTML =
      '<li class="text-red-400 text-center py-4">‚ùå Failed to load alerts.</li>';
  }
}

// üß≠ Refresh Button
document.getElementById("refreshAlerts").addEventListener("click", loadAlerts);

// üöÄ Load on page load
document.addEventListener("DOMContentLoaded", loadAlerts);


document.getElementById("logoutBtn").addEventListener("click", function (event) {
  event.preventDefault();

  // üßπ Remove adminId cookie
  document.cookie = "adminId=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax;";

  // Optional: clear JWT or any other related cookies if used
  document.cookie = "jwtToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax;";

  // üöÄ Redirect to admin login page
  window.location.href = "/adminLogin/";
});

// Mobile menu toggle
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');

menuToggle?.addEventListener('click', () => {
  sidebar.classList.toggle('-translate-x-full');
  sidebarOverlay.classList.toggle('hidden');
});

sidebarOverlay?.addEventListener('click', () => {
  sidebar.classList.add('-translate-x-full');
  sidebarOverlay.classList.add('hidden');
});

      </script>
    </main>
  </div>
</body>
</html>