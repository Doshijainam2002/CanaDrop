<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoices & Payments ‚Ä¢ CanaLogistiX Admin</title>
  <!-- <link rel="icon" href="https://canalogistix.s3.us-east-2.amazonaws.com/Logo/CanaLogistiX_Logo_BG.png"> -->
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512.png">
  <link rel="apple-touch-icon" href="/favicon-512.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  body { font-family: 'Inter', sans-serif; }
  .logistics-bg {
    background:
      linear-gradient(135deg, rgba(255,255,255,0.04) 25%, rgba(0,0,0,0) 25%) 0 0/28px 28px,
      linear-gradient(135deg, rgba(0,0,0,0) 75%, rgba(255,255,255,0.04) 75%) 0 0/28px 28px;
    box-shadow: inset 0 0 120px rgba(0,0,0,0.35);
  }
  
  /* Toast Notification Animations */
  @keyframes slideIn {
    from {
      transform: translateX(400px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(400px);
      opacity: 0;
    }
  }
  </style>
</head>
<body class="min-h-screen bg-neutral-900 text-neutral-100 logistics-bg">

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-neutral-800 border-r border-neutral-700 flex flex-col fixed lg:static inset-y-0 left-0 z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 overflow-y-auto">
      <div class="flex items-center h-16 border-b border-neutral-700 px-6">
        <img src="https://canalogistix.s3.us-east-2.amazonaws.com/Logo/CanaLogistiX_Logo_BG.png" alt="CanaLogistiX Logo" class="h-12 w-12 rounded-full object-cover"/>
        <span class="ml-2 text-lg font-semibold text-white">CanaLogistiX</span>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 p-4 space-y-2 text-sm overflow-y-auto">
        <a href="/adminDashboard/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M13 5v6h6"/></svg>
          Dashboard
        </a>
        <a href="/adminOrders/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm6 0v-8a2 2 0 00-2-2h-2a2 2 0 00-2 2v8m6 0a2 2 0 002 2h2a2 2 0 002-2"/></svg>
          Orders
        </a>
        <a href="/adminPharmacies/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V5a3 3 0 00-3-3H7a3 3 0 00-3 3v6m12 0v6a3 3 0 01-3 3H7a3 3 0 01-3-3v-6m12 0H4"/></svg>
          Pharmacies
        </a>
        <a href="/adminDrivers/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          Drivers
        </a>
        <a href="/adminInvoices/" class="flex items-center px-3 py-2 rounded-lg bg-gradient-to-r from-orange-600 to-orange-500 text-white font-medium">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 4H7a2 2 0 01-2-2V6a2 2 0 012-2h7l5 5v9a2 2 0 01-2 2z"/></svg>
          Invoices
        </a>
        <a href="/adminAnalyticsAndReports/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          Analytics &amp; Reports
        </a>
        <a href="/adminPharmacyInformation/"
          class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
          </svg>
          Pharmacy Information
        </a>
        <a href="/adminSupport/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8s-9-3.582-9-8 4.03-8 9-8 9 3.582 9 8zM12 14v-4m0 4h.01"/></svg>
          Support
        </a>
        <a href="#" 
        id="logoutBtn"
        class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h6a2 2 0 012 2v1" />
            </svg>
            Logout
        </a>

      </nav>

      <!-- Profile -->
      <div class="p-4 border-t border-neutral-700">
        <div class="flex items-center">
          <div class="flex-shrink-0 w-9 h-9 bg-gradient-to-r from-orange-600 to-orange-500 rounded-full flex items-center justify-center text-sm font-semibold">A</div>
          <div class="ml-3">
            <p class="text-sm font-medium text-neutral-100">Admin</p>
            <p class="text-xs text-neutral-400">admin@canadrop.ca</p>
          </div>
        </div>
      </div>
    </aside>

    <div id="sidebarOverlay" class="hidden lg:hidden fixed inset-0 bg-black/50 z-30"></div>

    <!-- Main -->
    <main class="flex-1 flex flex-col overflow-y-auto lg:ml-0">
      <header class="bg-neutral-800 border-b border-neutral-700 px-4 sm:px-6 py-4 flex items-center justify-between gap-4">
        <button id="menuToggle" class="lg:hidden text-white p-2 flex-shrink-0">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
        <div class="flex-1 min-w-0">
          <h1 class="text-xl sm:text-2xl font-bold text-white truncate">Invoices & Payments</h1>
          <p class="text-sm text-neutral-400 hidden sm:block">Manage pharmacy and driver billing cycles, payments, and reports</p>
        </div>
      </header>

      <!-- Pharmacy Invoices -->
      <section class="px-4 sm:px-6 py-6 sm:py-8">
        <div class="bg-neutral-800/80 border border-neutral-700 rounded-xl p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
            <h2 class="text-lg font-semibold text-white">Pharmacy Invoices</h2>
          </div>
          <div class="mb-4 flex flex-col sm:flex-row gap-3">
            <input 
              type="text" 
              id="pharmacySearchInput" 
              placeholder="Search by pharmacy name or invoice ID..." 
              class="flex-1 px-4 py-2 bg-neutral-900 border border-neutral-600 rounded-lg text-sm text-neutral-100 focus:outline-none focus:border-orange-500"
            />
            <select 
              id="pharmacyStatusFilter" 
              class="px-4 py-2 bg-neutral-900 border border-neutral-600 rounded-lg text-sm text-neutral-100 focus:outline-none focus:border-orange-500"
            >
              <option value="">All Statuses</option>
              <option value="generated">Generated</option>
              <option value="paid">Paid</option>
              <option value="past_due">Past Due</option>
            </select>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-neutral-800 border-b border-neutral-700">
                <tr>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Invoice ID</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Pharmacy</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Period</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Total ($)</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Reference ID</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="pharmacyInvoicesBody" class="divide-y divide-neutral-700">
                <tr class="hover:bg-neutral-700/50 transition">
                  <td class="px-6 py-4 text-neutral-100 font-medium">INV-P-203</td>
                  <td class="px-6 py-4 text-neutral-300">HealthPlus Pharmacy</td>
                  <td class="px-6 py-4 text-neutral-300">Oct 1 ‚Äì Oct 31</td>
                  <td class="px-6 py-4 text-neutral-100 font-semibold">$480.00</td>
                  <td class="px-6 py-4">
                    <span class="inline-flex px-3 py-1 text-xs font-medium rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-600/40">Past Due</span>
                  </td>
                  <td class="px-6 py-4 space-x-2">
                    <button class="text-xs text-orange-400 border border-orange-600/40 px-3 py-1 rounded hover:bg-orange-600/20">View PDF</button>
                    <button class="text-xs text-green-400 border border-green-600/40 px-3 py-1 rounded hover:bg-green-600/20">Mark Paid</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Pagination -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mt-4 pt-4 border-t border-neutral-700">
              <p class="text-sm text-neutral-400">
                Showing <span id="pharmacyStart">1</span>-<span id="pharmacyEnd">10</span> of <span id="pharmacyTotal">0</span>
              </p>
              <div class="flex gap-2 w-full sm:w-auto">
                <button id="pharmacyPrevBtn" class="flex-1 sm:flex-none px-3 py-1 text-sm border border-neutral-600 rounded hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Previous
              </button>
              <button id="pharmacyNextBtn" class="px-3 py-1 text-sm border border-neutral-600 rounded hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Next
              </button>
            </div>
          </div>
          </div>
        </div>
      </section>

      <!-- Driver Invoices -->
      <section class="px-4 sm:px-6 pb-6 sm:pb-8">
        <div class="bg-neutral-800/80 border border-neutral-700 rounded-xl p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
            <h2 class="text-lg font-semibold text-white">Driver Invoices</h2>
          </div>
          <div class="mb-4 flex flex-col sm:flex-row gap-3">
            <input 
              type="text" 
              id="driverSearchInput" 
              placeholder="Search by driver name or invoice ID..." 
              class="flex-1 px-4 py-2 bg-neutral-900 border border-neutral-600 rounded-lg text-sm text-neutral-100 focus:outline-none focus:border-orange-500"
            />
            <select 
              id="driverStatusFilter" 
              class="px-4 py-2 bg-neutral-900 border border-neutral-600 rounded-lg text-sm text-neutral-100 focus:outline-none focus:border-orange-500"
            >
              <option value="">All Statuses</option>
              <option value="generated">Pending</option>
              <option value="paid">Paid</option>
            </select>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-neutral-800 border-b border-neutral-700">
                <tr>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Invoice ID</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Driver</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Period</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Total ($)</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Reference ID</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="driverInvoicesBody" class="divide-y divide-neutral-700">
                <tr class="hover:bg-neutral-700/50 transition">
                  <td class="px-6 py-4 text-neutral-100 font-medium">INV-D-155</td>
                  <td class="px-6 py-4 text-neutral-300">John Doe</td>
                  <td class="px-6 py-4 text-neutral-300">Oct 1 ‚Äì Oct 31</td>
                  <td class="px-6 py-4 text-neutral-100 font-semibold">$145.00</td>
                  <td class="px-6 py-4">
                    <span class="inline-flex px-3 py-1 text-xs font-medium rounded-full bg-orange-500/20 text-orange-400 border border-orange-600/40">Pending</span>
                  </td>
                  <td class="px-6 py-4 space-x-2">
                    <button class="text-xs text-orange-400 border border-orange-600/40 px-3 py-1 rounded hover:bg-orange-600/20">View PDF</button>
                    <button class="text-xs text-green-400 border border-green-600/40 px-3 py-1 rounded hover:bg-green-600/20">Mark Paid</button>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Pagination -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mt-4 pt-4 border-t border-neutral-700">
              <p class="text-sm text-neutral-400">
                Showing <span id="driverStart">1</span>-<span id="driverEnd">10</span> of <span id="driverTotal">0</span>
              </p>
              <div class="flex gap-2 w-full sm:w-auto">
                <button id="driverPrevBtn" class="flex-1 sm:flex-none px-3 py-1 text-sm border border-neutral-600 rounded hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed">
                  Previous
                </button>
                <button id="driverNextBtn" class="flex-1 sm:flex-none px-3 py-1 text-sm border border-neutral-600 rounded hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed">
                  Next
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Payment Alerts -->
      <section class="px-4 sm:px-6 pb-6 sm:pb-8">
        <div class="bg-neutral-800/80 border border-neutral-700 rounded-xl p-6">
          <h2 class="text-lg font-semibold text-white mb-4">Payment Alerts</h2>

          <!-- Legend / Color Coding Note -->
          <div class="mb-4 text-xs text-neutral-400 space-y-1">
            <p class="font-medium text-neutral-300">Legend:</p>
            <p class="flex items-center">
              <span class="w-2.5 h-2.5 bg-red-500 rounded-full mr-2"></span>
              <span>Overdue invoices &mdash; immediate action required</span>
            </p>
            <p class="flex items-center">
              <span class="w-2.5 h-2.5 bg-yellow-500 rounded-full mr-2"></span>
              <span>Invoices due within 3 days</span>
            </p>
            <p class="flex items-center">
              <span class="w-2.5 h-2.5 bg-neutral-500 rounded-full mr-2"></span>
              <span>Upcoming / informational alerts</span>
            </p>
          </div>

          <ul id="paymentAlertsList" class="space-y-3 text-sm">
            <li class="text-neutral-400">Loading alerts...</li>
          </ul>

          <!-- Pagination -->
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mt-4 pt-4 border-t border-neutral-700">
            <p class="text-sm text-neutral-400">
              Showing <span id="alertsStart">1</span>-<span id="alertsEnd">10</span> of <span id="alertsTotal">0</span>
            </p>
            <div class="flex gap-2 w-full sm:w-auto">
              <button id="alertsPrevBtn" class="flex-1 sm:flex-none px-3 py-1 text-sm border border-neutral-600 rounded hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Previous
              </button>
              <button id="alertsNextBtn" class="flex-1 sm:flex-none px-3 py-1 text-sm border border-neutral-600 rounded hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed">
                Next
              </button>
            </div>
          </div>
        </div>
      </section>



<!-- Revenue Reports -->
<section class="px-4 sm:px-6 pb-8 sm:pb-10">
  <div class="bg-neutral-800/80 border border-neutral-700 rounded-xl p-6">
    <h2 class="text-lg font-semibold text-white mb-4">Revenue Reports</h2>

    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6 text-center">

      <!-- Revenue -->
      <div class="bg-neutral-900 border border-neutral-700 rounded-xl p-4 sm:p-5 relative group">
        <div class="flex items-center justify-center gap-2 mb-1">
          <p class="text-sm text-neutral-400">Total Revenue (This Month)</p>
          <div class="relative">
            <svg class="w-4 h-4 text-neutral-500 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <!-- Tooltip -->
            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-neutral-700 text-neutral-100 text-xs rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10 pointer-events-none">
              <p class="font-semibold mb-1">Total Revenue</p>
              <p>Sum of all delivery fees from orders marked as "delivered" this month. This represents gross income before driver payouts.</p>
              <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                <div class="border-4 border-transparent border-t-neutral-700"></div>
              </div>
            </div>
          </div>
        </div>
        <p id="revThisMonth" class="text-2xl font-bold text-green-400">$0.00</p>
      </div>

      <!-- Driver Payout -->
      <div class="bg-neutral-900 border border-neutral-700 rounded-xl p-4 sm:p-5 relative group">
        <div class="flex items-center justify-center gap-2 mb-1">
          <p class="text-sm text-neutral-400">Driver Payouts (This Month)</p>
          <div class="relative">
            <svg class="w-4 h-4 text-neutral-500 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <!-- Tooltip -->
            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-neutral-700 text-neutral-100 text-xs rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10 pointer-events-none">
              <p class="font-semibold mb-1">Driver Payouts</p>
              <p>Total amount owed to drivers this month of the total revenue. This is the driver's share of each delivery fee.</p>
              <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                <div class="border-4 border-transparent border-t-neutral-700"></div>
              </div>
            </div>
          </div>
        </div>
        <p id="payoutThisMonth" class="text-2xl font-bold text-orange-400">$0.00</p>
      </div>

      <!-- Net Commission -->
      <div class="bg-neutral-900 border border-neutral-700 rounded-xl p-4 sm:p-5 relative group">
        <div class="flex items-center justify-center gap-2 mb-1">
          <p class="text-sm text-neutral-400">Net Commission Margin</p>
          <div class="relative">
            <svg class="w-4 h-4 text-neutral-500 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <!-- Tooltip -->
            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-neutral-700 text-neutral-100 text-xs rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10 pointer-events-none">
              <p class="font-semibold mb-1">Net Commission</p>
              <p>Company's earnings after driver payouts of the total revenue. This covers platform operations and represents net profit.</p>
              <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                <div class="border-4 border-transparent border-t-neutral-700"></div>
              </div>
            </div>
          </div>
        </div>
        <p id="netCommission" class="text-2xl font-bold text-blue-400">0% ($0.00)</p>
      </div>

    </div>
  </div>
</section>

<!-- Mark Paid Modal -->
<div id="markPaidModal" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
  <div class="bg-neutral-800 border border-neutral-700 rounded-xl max-w-md w-full p-6">
    <h3 id="modalTitle" class="text-lg font-semibold text-white mb-4">Mark Invoice as Paid</h3>
    <p id="modalDescription" class="text-sm text-neutral-400 mb-4">Enter the payment reference ID to mark this invoice as paid.</p>
    
    <input 
      type="text" 
      id="paymentReferenceInput" 
      placeholder="e.g., pi_3xyz123 or TRANSFER-2024-001" 
      class="w-full px-4 py-2 bg-neutral-900 border border-neutral-600 rounded-lg text-sm text-neutral-100 focus:outline-none focus:border-orange-500 mb-4"
    />
    
    <div class="flex gap-3">
      <button 
        id="cancelMarkPaid" 
        class="flex-1 px-4 py-2 border border-neutral-600 rounded-lg text-sm text-neutral-300 hover:bg-neutral-700 transition"
      >
        Cancel
      </button>
      <button 
        id="confirmMarkPaid" 
        class="flex-1 px-4 py-2 bg-gradient-to-r from-green-600 to-green-500 rounded-lg text-sm text-white font-medium hover:from-green-500 hover:to-green-400 transition"
      >
        Confirm Payment
      </button>
    </div>
  </div>
</div>


      <script>
        document.getElementById("logoutBtn").addEventListener("click", function (event) {
  event.preventDefault();

  // üßπ Remove adminId cookie
  document.cookie = "adminId=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax;";

  // Optional: clear JWT or any other related cookies if used
  document.cookie = "jwtToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax;";

  // üöÄ Redirect to admin login page
  window.location.href = "/adminLogin/";
});


        function getCSRFToken() {
            return document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
        }


// Pagination state
let pharmacyPage = 1;
let driverPage = 1;
let alertsPage = 1;
const itemsPerPage = 10;

let currentInvoiceId = null;
let currentInvoiceType = null;

// Filter state
let pharmacyAllData = [];
let driverAllData = [];
let alertsAllData = [];

// ADD THESE NEW VARIABLES - Store filtered data
let pharmacyFilteredData = [];
let driverFilteredData = [];



// Custom Toast Notification System
function showNotification(message, type = 'info') {
  // Remove any existing notification
  const existingNotification = document.getElementById('customNotification');
  if (existingNotification) {
    existingNotification.remove();
  }

  // Determine colors and icon based on type
  let bgColor, borderColor, textColor, icon;
  
  switch(type) {
    case 'success':
      bgColor = 'bg-green-600';
      borderColor = 'border-green-500';
      textColor = 'text-green-100';
      icon = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      `;
      break;
    case 'error':
      bgColor = 'bg-red-600';
      borderColor = 'border-red-500';
      textColor = 'text-red-100';
      icon = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      `;
      break;
    case 'warning':
      bgColor = 'bg-yellow-600';
      borderColor = 'border-yellow-500';
      textColor = 'text-yellow-100';
      icon = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
        </svg>
      `;
      break;
    default: // info
      bgColor = 'bg-blue-600';
      borderColor = 'border-blue-500';
      textColor = 'text-blue-100';
      icon = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      `;
  }

  // Create notification element
  const notification = document.createElement('div');
  notification.id = 'customNotification';
  notification.className = `fixed top-4 right-4 z-[9999] ${bgColor} ${textColor} border ${borderColor} rounded-lg shadow-lg p-4 flex items-center gap-3 min-w-[300px] max-w-[500px] animate-slideIn`;
  notification.style.animation = 'slideIn 0.3s ease-out';
  
  notification.innerHTML = `
    <div class="flex-shrink-0">
      ${icon}
    </div>
    <div class="flex-1 text-sm font-medium">
      ${message}
    </div>
    <button onclick="this.parentElement.remove()" class="flex-shrink-0 ml-2 hover:opacity-75 transition">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  `;

  // Add to document
  document.body.appendChild(notification);

  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification && notification.parentElement) {
      notification.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => {
        if (notification && notification.parentElement) {
          notification.remove();
        }
      }, 300);
    }
  }, 5000);
}


// Pharmacy filters
document.getElementById('pharmacySearchInput').addEventListener('input', filterAndRenderPharmacy);
document.getElementById('pharmacyStatusFilter').addEventListener('change', filterAndRenderPharmacy);
document.getElementById('pharmacyPrevBtn').addEventListener('click', () => changePage('pharmacy', -1));
document.getElementById('pharmacyNextBtn').addEventListener('click', () => changePage('pharmacy', 1));

// Driver filters
document.getElementById('driverSearchInput').addEventListener('input', filterAndRenderDriver);
document.getElementById('driverStatusFilter').addEventListener('change', filterAndRenderDriver);
document.getElementById('driverPrevBtn').addEventListener('click', () => changePage('driver', -1));
document.getElementById('driverNextBtn').addEventListener('click', () => changePage('driver', 1));

// Alerts pagination
document.getElementById('alertsPrevBtn').addEventListener('click', () => changePage('alerts', -1));
document.getElementById('alertsNextBtn').addEventListener('click', () => changePage('alerts', 1));



// Filter and render pharmacy invoices
function filterAndRenderPharmacy() {
  pharmacyPage = 1; // Reset to page 1 when filtering
  const searchTerm = document.getElementById('pharmacySearchInput').value.toLowerCase();
  const statusFilter = document.getElementById('pharmacyStatusFilter').value;
  
  pharmacyFilteredData = pharmacyAllData.filter(inv => {
    const matchesSearch = 
      inv.pharmacy_name.toLowerCase().includes(searchTerm) ||
      `INV-${inv.invoice_id}`.toLowerCase().includes(searchTerm);
    const matchesStatus = !statusFilter || inv.status === statusFilter;
    
    return matchesSearch && matchesStatus;
  });
  
  renderPharmacyInvoices(pharmacyFilteredData, pharmacyPage);
  updatePaginationControls('pharmacy', pharmacyAllData.length, pharmacyFilteredData.length);
}

// Filter and render driver invoices
function filterAndRenderDriver() {
  driverPage = 1;
  const searchTerm = document.getElementById('driverSearchInput').value.toLowerCase();
  const statusFilter = document.getElementById('driverStatusFilter').value;
  
  driverFilteredData = driverAllData.filter(inv => {
    const matchesSearch = 
      inv.driver_name.toLowerCase().includes(searchTerm) ||
      `INV-${inv.invoice_id}`.toLowerCase().includes(searchTerm);
    const matchesStatus = !statusFilter || inv.status === statusFilter;
    
    return matchesSearch && matchesStatus;
  });
  
  renderDriverInvoices(driverFilteredData, driverPage);
  updatePaginationControls('driver', driverAllData.length, driverFilteredData.length);
}

// Handle page changes
function changePage(type, direction) {
  if (type === 'pharmacy') {
    pharmacyPage += direction;
    renderPharmacyInvoices(pharmacyFilteredData, pharmacyPage);
    updatePaginationControls('pharmacy', pharmacyAllData.length, pharmacyFilteredData.length);
  } else if (type === 'driver') {
    driverPage += direction;
    renderDriverInvoices(driverFilteredData, driverPage);
    updatePaginationControls('driver', driverAllData.length, driverFilteredData.length);
  } else if (type === 'alerts') {
    alertsPage += direction;
    renderAlertsPaginated();
  }
}

// Update pagination controls
function updatePaginationControls(type, total, filtered) {
  const startId = `${type}Start`;
  const endId = `${type}End`;
  const totalId = `${type}Total`;
  const prevBtnId = `${type}PrevBtn`;
  const nextBtnId = `${type}NextBtn`;
  
  const currentPage = type === 'pharmacy' ? pharmacyPage : (type === 'driver' ? driverPage : alertsPage);
  const start = (currentPage - 1) * itemsPerPage + 1;
  const end = Math.min(currentPage * itemsPerPage, filtered);
  const totalPages = Math.ceil(filtered / itemsPerPage);
  
  document.getElementById(startId).textContent = filtered > 0 ? start : 0;
  document.getElementById(endId).textContent = end;
  document.getElementById(totalId).textContent = filtered;
  
  document.getElementById(prevBtnId).disabled = currentPage === 1;
  document.getElementById(nextBtnId).disabled = currentPage >= totalPages;
}

// Render alerts with pagination
function renderAlertsPaginated() {
  const list = document.getElementById("paymentAlertsList");
  const start = (alertsPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const paginatedAlerts = alertsAllData.slice(start, end);
  
  if (paginatedAlerts.length === 0) {
    list.innerHTML = `<li class="text-neutral-400">No payment alerts üéâ</li>`;
    updatePaginationControls('alerts', 0, 0);
    return;
  }
  
  list.innerHTML = paginatedAlerts.map(alert => {
    // Determine color coding
    let dotColor = "bg-neutral-500";
    let textColor = "text-neutral-300";

    if (alert.days_left < 0) {
      dotColor = "bg-red-500";      // overdue
      textColor = "text-red-400";
    } else if (alert.days_left <= 3) {
      dotColor = "bg-yellow-500";   // due soon
      textColor = "text-yellow-400";
    }

    // Friendly label
    const entityType = alert.type === "pharmacy" ? "Pharmacy" : "Driver";
    const invoiceCode = alert.type === "pharmacy" 
                        ? `INV-${alert.invoice_id}` 
                        : `INV-${alert.invoice_id}`;

    const periodText = `Due: ${alert.due_date} (${alert.days_left} days left)`;

    return `
      <li class="flex flex-col sm:flex-row sm:items-center sm:justify-between ${textColor}">
        <div class="flex items-center mb-1 sm:mb-0">
          <span class="w-2.5 h-2.5 ${dotColor} rounded-full mr-2"></span>
          <span>
            <strong>${entityType}:</strong> ${alert.entity_name} ‚Äî ${invoiceCode}
          </span>
        </div>
        <span class="text-xs text-neutral-400 ml-5 sm:ml-0">
          ${periodText}
        </span>
      </li>
    `;
  }).join("");
  
  updatePaginationControls('alerts', alertsAllData.length, alertsAllData.length);
}


// Optional helper: status badge for invoices
function getInvoiceStatusBadge(status) {
  // API returns: generated, paid, past_due
  let config = {
    bg: 'bg-neutral-500/20',
    text: 'text-neutral-300',
    border: 'border border-neutral-500/40',
    label: status
  };

  if (status === 'generated') {
    config = {
      bg: 'bg-blue-500/20',
      text: 'text-blue-400',
      border: 'border border-blue-600/40',
      label: 'Generated'
    };
  } else if (status === 'paid') {
    config = {
      bg: 'bg-green-500/20',
      text: 'text-green-400',
      border: 'border border-green-600/40',
      label: 'Paid'
    };
  } else if (status === 'past_due') {
    config = {
      bg: 'bg-yellow-500/20',
      text: 'text-yellow-400',
      border: 'border border-yellow-600/40',
      label: 'Past Due'
    };
  }

  return `
    <span class="inline-flex px-3 py-1 text-xs font-medium rounded-full ${config.bg} ${config.text} ${config.border}">
      ${config.label}
    </span>
  `;
}

// Render pharmacy invoices into the table with pagination
function renderPharmacyInvoices(invoices, page = 1) {
  const tbody = document.getElementById('pharmacyInvoicesBody');
  if (!tbody) return;

  if (!invoices || invoices.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="px-6 py-6 text-center text-neutral-400">
          No invoices found
        </td>
      </tr>
    `;
    updatePaginationControls('pharmacy', 0, 0);
    return;
  }

  // Apply pagination
  const start = (page - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const paginatedInvoices = invoices.slice(start, end);

  tbody.innerHTML = paginatedInvoices.map(inv => {
    const invoiceCode = `INV-${inv.invoice_id}`;
    const periodText = `${inv.period.start_date} ‚Äì ${inv.period.end_date}`;
    const totalFormatted = parseFloat(inv.total_amount).toFixed(2);
    const stripePaymentId = inv.stripe_payment_id || '<span class="text-neutral-500">N/A</span>';

    const viewPdfButton = inv.pdf_url
      ? `<button onclick="window.open('${inv.pdf_url}', '_blank')" class="text-xs text-orange-400 border border-orange-600/40 px-3 py-1 rounded hover:bg-orange-600/20">View PDF</button>`
      : `<span class="text-xs text-neutral-500">No PDF</span>`;

    const markPaidButton = inv.status !== 'paid'
      ? `<button onclick="markPharmacyInvoicePaid(${inv.invoice_id})" class="text-xs text-green-400 border border-green-600/40 px-3 py-1 rounded hover:bg-green-600/20 whitespace-nowrap">
          Mark Paid
        </button>`
      : `<span class="text-xs text-neutral-500">Already Paid</span>`;

    return `
      <tr class="hover:bg-neutral-700/50 transition">
        <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-100 font-medium">${invoiceCode}</td>
        <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-300">${inv.pharmacy_name}</td>
        <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-300">${periodText}</td>
        <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-100 font-semibold">$${totalFormatted}</td>
        <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-300 text-xs break-all max-w-[200px]">${stripePaymentId}</td>
        <td class="px-4 sm:px-6 py-3 sm:py-4">
          ${getInvoiceStatusBadge(inv.status)}
        </td>
        <td class="px-4 sm:px-6 py-3 sm:py-4">
          <div class="flex flex-col sm:flex-row gap-2">
            ${viewPdfButton}
            ${markPaidButton}
          </div>
        </td>
      </tr>
    `;
  }).join('');

  // Update pagination controls
  updatePaginationControls('pharmacy', pharmacyAllData.length, invoices.length);
}


// Mark Pharmacy Invoice as Paid
function markPharmacyInvoicePaid(invoiceId) {
  currentInvoiceId = invoiceId;
  currentInvoiceType = 'pharmacy';
  document.getElementById('modalTitle').textContent = 'Mark Pharmacy Invoice as Paid';
  document.getElementById('modalDescription').textContent = 'Enter the Stripe payment ID to mark this invoice as paid.';
  document.getElementById('paymentReferenceInput').placeholder = 'e.g., pi_3xyz123abc';
  document.getElementById('paymentReferenceInput').value = '';
  document.getElementById('markPaidModal').classList.remove('hidden');
}

// Load invoices from the API
async function loadPharmacyInvoices() {
  const tbody = document.getElementById('pharmacyInvoicesBody');
  if (tbody) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="px-6 py-6 text-center text-neutral-400">
          Loading invoices...
        </td>
      </tr>
    `;
  }

  try {
    const res = await fetch('/api/admin/invoices/all/', {
      method: 'GET',
      credentials: 'include', // ‚úÖ send authToken cookie
      headers: {
        'X-CSRFToken': getCSRFToken() // ‚úÖ CSRF token
      }
    });

    if (!res.ok) {
      const text = await res.text();
      console.error('Invoice API error:', text);
      showNotification(`Failed to load invoices: ${res.status}`, 'error');
      return;
    }

    const contentType = res.headers.get('content-type') || '';
    if (!contentType.includes('application/json')) {
      const text = await res.text();
      console.error('Non-JSON response from /invoices/all/:', text);
      showNotification('Server returned non-JSON response for invoices.', 'error');
      return;
    }

    const data = await res.json();

    if (!data.success) {
      showNotification(data.message || 'Failed to load invoices', 'error');
      return;
    }

    // STORE DATA AND RESET PAGE
    pharmacyAllData = data.invoices || [];
    pharmacyPage = 1;
    
    // USE FILTER FUNCTION TO RENDER
    filterAndRenderPharmacy();
    
  } catch (err) {
    console.error('Invoices load error:', err);
    showNotification('Error loading invoices: ' + err.message, 'error');
  }
}


// Helper: status badge for driver invoices
function getDriverInvoiceStatusBadge(status) {
  // API statuses: "generated", "paid"
  if (status === "paid") {
    return `
      <span class="inline-flex px-3 py-1 text-xs font-medium rounded-full bg-green-500/20 text-green-400 border border-green-600/40">
        Paid
      </span>
    `;
  }

  // Treat "generated" as Pending
  return `
    <span class="inline-flex px-3 py-1 text-xs font-medium rounded-full bg-orange-500/20 text-orange-400 border border-orange-600/40">
      Pending
    </span>
  `;
}

// Render driver invoices into the table with pagination
function renderDriverInvoices(invoices, page = 1) {
  const tbody = document.getElementById("driverInvoicesBody");
  if (!tbody) return;

  if (!invoices || invoices.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="px-6 py-6 text-center text-neutral-400">
          No driver invoices found
        </td>
      </tr>
    `;
    updatePaginationControls('driver', 0, 0);
    return;
  }

  // Apply pagination
  const start = (page - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const paginatedInvoices = invoices.slice(start, end);

  tbody.innerHTML = paginatedInvoices
    .map((inv) => {
      const invoiceCode = `INV-${inv.invoice_id}`;
      const periodText = `${inv.start_date} ‚Äì ${inv.end_date}`;
      const totalFormatted = inv.total_amount.toFixed(2);
      const paymentReferenceId = inv.payment_reference_id || '<span class="text-neutral-500">N/A</span>';

      const viewPdfButton = inv.pdf_url
        ? `<button onclick="window.open('${inv.pdf_url}', '_blank')" class="text-xs text-orange-400 border border-orange-600/40 px-3 py-1 rounded hover:bg-orange-600/20">View PDF</button>`
        : `<span class="text-xs text-neutral-500">No PDF</span>`;

      // Only show Mark Paid button if status is not already paid
      const markPaidButton = inv.status !== 'paid'
        ? `<button onclick="markDriverInvoicePaid(${inv.invoice_id})" class="text-xs text-green-400 border border-green-600/40 px-3 py-1 rounded hover:bg-green-600/20 whitespace-nowrap">
            Mark Paid
          </button>`
        : `<span class="text-xs text-neutral-500">Already Paid</span>`;

      return `
        <tr class="hover:bg-neutral-700/50 transition">
          <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-100 font-medium">${invoiceCode}</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-300">${inv.driver_name}</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-300">${periodText}</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-100 font-semibold">$${totalFormatted}</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-300 text-xs break-all max-w-[200px]">${paymentReferenceId}</td>
          <td class="px-4 sm:px-6 py-3 sm:py-4">
            ${getDriverInvoiceStatusBadge(inv.status)}
          </td>
          <td class="px-4 sm:px-6 py-3 sm:py-4">
            <div class="flex flex-col sm:flex-row gap-2">
              ${viewPdfButton}
              ${markPaidButton}
            </div>
          </td>
        </tr>
      `;
    })
    .join("");

  // Update pagination controls
  updatePaginationControls('driver', driverAllData.length, invoices.length);
}

// Placeholder for Mark Paid ‚Äì to be wired when you have the API
function markDriverInvoicePaid(invoiceId) {
  currentInvoiceId = invoiceId;
  currentInvoiceType = 'driver'; // ADD THIS LINE
  document.getElementById('modalTitle').textContent = 'Mark Driver Invoice as Paid'; // ADD THIS LINE
  document.getElementById('modalDescription').textContent = 'Enter the payment reference ID to mark this invoice as paid.'; // ADD THIS LINE
  document.getElementById('paymentReferenceInput').placeholder = 'e.g., TRANSFER-2024-001'; // ADD THIS LINE
  document.getElementById('paymentReferenceInput').value = '';
  document.getElementById('markPaidModal').classList.remove('hidden');
}

// Handle modal close
// Handle modal close
document.getElementById('cancelMarkPaid')?.addEventListener('click', () => {
  document.getElementById('markPaidModal').classList.add('hidden');
  currentInvoiceId = null;
  currentInvoiceType = null; // ADD THIS LINE
});

// Handle confirm payment
// Handle confirm payment
document.getElementById('confirmMarkPaid')?.addEventListener('click', async () => {
  const referenceId = document.getElementById('paymentReferenceInput').value.trim();
  
  if (!referenceId) {
    showNotification('Please enter a payment reference ID', 'error');
    return;
  }
  
  if (!currentInvoiceId || !currentInvoiceType) {
    showNotification('No invoice selected', 'error');
    return;
  }
  
  // Store invoice type before clearing it
  const invoiceType = currentInvoiceType;
  
  // Determine API endpoint and field name based on invoice type
  const apiUrl = invoiceType === 'pharmacy' 
    ? `/api/admin/pharmacy-invoices/${currentInvoiceId}/mark-paid/`
    : `/api/admin/driver-invoices/${currentInvoiceId}/mark-paid/`;
  
  const fieldName = invoiceType === 'pharmacy' 
    ? 'stripe_payment_id' 
    : 'payment_reference_id';
  
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCSRFToken()
      },
      body: JSON.stringify({
        [fieldName]: referenceId
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showNotification('Invoice marked as paid successfully!', 'success');
      document.getElementById('markPaidModal').classList.add('hidden');
      
      // Clear state
      currentInvoiceId = null;
      currentInvoiceType = null;
      
      // Reload the appropriate invoice list
      if (invoiceType === 'pharmacy') {
        await loadPharmacyInvoices();
      } else {
        await loadDriverInvoices();
      }
    } else {
      showNotification(data.message || 'Failed to mark invoice as paid', 'error');
    }
  } catch (err) {
    console.error('Error marking invoice as paid:', err);
    showNotification('Error marking invoice as paid: ' + err.message, 'error');
  }
});

// Load driver invoices from API
async function loadDriverInvoices() {
  const tbody = document.getElementById("driverInvoicesBody");
  if (tbody) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="px-6 py-6 text-center text-neutral-400">
          Loading driver invoices...
        </td>
      </tr>
    `;
  }

  try {
    const res = await fetch("/api/admin/driver-invoices/all/", {
      method: "GET",
      credentials: "include", // ‚úÖ send auth cookies
      headers: {
        "X-CSRFToken": getCSRFToken(), // ‚úÖ CSRF token
      },
    });

    if (!res.ok) {
      const text = await res.text();
      console.error("Driver invoices API error:", text);
      showNotification(`Failed to load driver invoices: ${res.status}`, "error");
      return;
    }

    const contentType = res.headers.get("content-type") || "";
    if (!contentType.includes("application/json")) {
      const text = await res.text();
      console.error("Non-JSON response from /api/admin/driver-invoices/all/:", text);
      showNotification("Server returned non-JSON response for driver invoices.", "error");
      return;
    }

    const data = await res.json();

    if (!data.success) {
      showNotification(data.message || "Failed to load driver invoices", "error");
      return;
    }

    // STORE DATA AND RESET PAGE
    driverAllData = data.invoices || [];
    driverPage = 1;
    
    // USE FILTER FUNCTION TO RENDER
    filterAndRenderDriver();
    
  } catch (err) {
    console.error("Driver invoices load error:", err);
    showNotification("Error loading driver invoices: " + err.message, "error");
  }
}



// Load Payment Alerts
async function loadPaymentAlerts() {
  const list = document.getElementById("paymentAlertsList");
  list.innerHTML = `<li class="text-neutral-400">Loading alerts...</li>`;

  try {
    const response = await fetch("/api/admin/payment-alerts/", {
      method: "GET",
      credentials: "include", // ‚úÖ send auth cookies
      headers: {
        "X-CSRFToken": getCSRFToken(), // ‚úÖ CSRF token
      },
    });

    if (!response.ok) {
      list.innerHTML = `<li class="text-red-400">‚ùå Failed to load alerts</li>`;
      return;
    }

    const data = await response.json();
    if (!data.success) {
      list.innerHTML = `<li class="text-red-400">‚ùå ${data.error || "Unknown error"}</li>`;
      return;
    }

    // STORE THE DATA
    alertsAllData = data.alerts || [];
    alertsPage = 1; // Reset to first page
    
    // RENDER WITH PAGINATION
    renderAlertsPaginated();

  } catch (err) {
    console.error("Payment alerts error:", err);
    list.innerHTML = `<li class="text-red-400">‚ùå Error loading alerts</li>`;
  }
}


async function loadFinancialMetrics() {
  try {
    const response = await fetch("/api/admin/financials/month/", {
      method: "GET",
      credentials: "include", // ‚úÖ send auth cookies
      headers: {
        "X-CSRFToken": getCSRFToken(), // ‚úÖ CSRF token
      },
    });

    if (!response.ok) {
      showNotification(`Error fetching financial metrics: ${response.status}`, "error");
      return;
    }

    const data = await response.json();

    if (!data.success) {
      showNotification(data.error || "Failed to load financial metrics", "error");
      return;
    }

    const metrics = data.financials;

    const revenue = metrics.revenue_this_month || 0;
    const payout = metrics.driver_payout_this_month || 0;
    const netValue = metrics.net_commission.value || 0;
    const netPercent = metrics.net_commission.percentage_of_revenue || 0;

    // Update HTML values
    document.getElementById("revThisMonth").textContent =
      `$${revenue.toFixed(2)}`;

    document.getElementById("payoutThisMonth").textContent =
      `$${payout.toFixed(2)}`;

    document.getElementById("netCommission").textContent =
      `${netPercent.toFixed(1)}% ($${netValue.toFixed(2)})`;

  } catch (err) {
    console.error("Financial metrics error:", err);
    showNotification("Failed to load revenue metrics", "error");
  }
}


// Mobile menu toggle
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');

menuToggle?.addEventListener('click', () => {
  sidebar.classList.toggle('-translate-x-full');
  sidebarOverlay.classList.toggle('hidden');
});

sidebarOverlay?.addEventListener('click', () => {
  sidebar.classList.add('-translate-x-full');
  sidebarOverlay.classList.add('hidden');
});


loadPharmacyInvoices();
loadDriverInvoices();
loadPaymentAlerts();
loadFinancialMetrics();



      </script>
    </main>
  </div>
</body>
</html>
