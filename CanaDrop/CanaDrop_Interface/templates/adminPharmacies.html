<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pharmacies Management • CanaLogistiX Admin</title>
  <!-- <link rel="icon" href="https://canalogistix.s3.us-east-2.amazonaws.com/Logo/CanaLogistiX_Logo_BG.png"> -->
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512.png">
  <link rel="apple-touch-icon" href="/favicon-512.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .logistics-bg {
      background:
        linear-gradient(135deg, rgba(255,255,255,0.04) 25%, rgba(0,0,0,0) 25%) 0 0/28px 28px,
        linear-gradient(135deg, rgba(0,0,0,0) 75%, rgba(255,255,255,0.04) 75%) 0 0/28px 28px;
      box-shadow: inset 0 0 120px rgba(0,0,0,0.35);
    }
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #262626; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #525252; border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #737373; }
  </style>
</head>
<body class="min-h-screen bg-neutral-900 text-neutral-100 logistics-bg">

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-neutral-800 border-r border-neutral-700 flex flex-col fixed lg:static inset-y-0 left-0 z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 overflow-y-auto">
      <div class="flex items-center h-16 border-b border-neutral-700 px-6">
        <img src="https://canalogistix.s3.us-east-2.amazonaws.com/Logo/CanaLogistiX_Logo_BG.png" alt="CanaLogistiX Logo" class="h-12 w-12 rounded-full object-cover"/>
        <span class="ml-2 text-lg font-semibold text-white">CanaLogistiX</span>
      </div>

      <!-- Navigation -->
      <nav class="flex-1 p-4 space-y-2 text-sm">
        <a href="/adminDashboard/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M13 5v6h6"/></svg>
          Dashboard
        </a>
        <a href="/adminOrders/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm6 0v-8a2 2 0 00-2-2h-2a2 2 0 00-2 2v8m6 0a2 2 0 002 2h2a2 2 0 002-2"/></svg>
          Orders
        </a>
        <a href="/adminPharmacies/" class="flex items-center px-3 py-2 rounded-lg bg-gradient-to-r from-orange-600 to-orange-500 text-white font-medium">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V5a3 3 0 00-3-3H7a3 3 0 00-3 3v6m12 0v6a3 3 0 01-3 3H7a3 3 0 01-3-3v-6m12 0H4"/></svg>
          Pharmacies
        </a>
        <a href="/adminDrivers/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
          Drivers
        </a>
        <a href="/adminInvoices/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 4H7a2 2 0 01-2-2V6a2 2 0 012-2h7l5 5v9a2 2 0 01-2 2z"/></svg>
          Invoices
        </a>
        <a href="/adminAnalyticsAndReports/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          Analytics &amp; Reports
        </a>
        <a href="/adminPharmacyInformation/"
          class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
          </svg>
          Pharmacy Information
        </a>
        <a href="/adminPaymentInformation/"
          class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
          </svg>
          Payment Information
        </a>
        <a href="/adminCCPoints/"
          class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          CC Points
        </a>
        <a href="/adminSupport/" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8s-9-3.582-9-8 4.03-8 9-8 9 3.582 9 8zM12 14v-4m0 4h.01"/></svg>
          Support
        </a>
        <a href="#" id="logoutBtn" class="flex items-center px-3 py-2 rounded-lg text-neutral-300 hover:bg-neutral-700 transition">
          <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h6a2 2 0 012 2v1" />
          </svg>
          Logout
        </a>
      </nav>

      <!-- Profile -->
      <div class="p-4 border-t border-neutral-700">
        <div class="flex items-center">
          <div class="flex-shrink-0 w-9 h-9 bg-gradient-to-r from-orange-600 to-orange-500 rounded-full flex items-center justify-center text-sm font-semibold">A</div>
          <div class="ml-3">
            <p class="text-sm font-medium text-neutral-100">Admin</p>
            <p class="text-xs text-neutral-400">admin@canadrop.ca</p>
          </div>
        </div>
      </div>
    </aside>

    <div id="sidebarOverlay" class="hidden lg:hidden fixed inset-0 bg-black/50 z-30"></div>

    <!-- Main -->
    <main class="flex-1 flex flex-col overflow-y-auto lg:ml-0">
      <header class="bg-neutral-800 border-b border-neutral-700 px-4 sm:px-6 py-4 flex items-center justify-between gap-4">
        <button id="menuToggle" class="lg:hidden text-white p-2 flex-shrink-0">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
        <div class="flex-1 min-w-0">
          <h1 class="text-xl sm:text-2xl font-bold text-white truncate">Pharmacies Management</h1>
          <p class="text-sm text-neutral-400 hidden sm:block">Manage pharmacy accounts, orders, and payments</p>
        </div>
      </header>

      <!-- Filters -->
      <section class="px-6 py-6 bg-neutral-900">
        <div class="bg-neutral-800/80 border border-neutral-700 rounded-xl p-6">
          <h2 class="text-lg font-semibold text-white mb-4">Search & Filters</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <input id="searchPharmacy" type="text" placeholder="Search Pharmacy by Name or Email" class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-sm w-full text-neutral-300 focus:ring-2 focus:ring-orange-500 focus:outline-none"/>
            
            <select id="filterCity" class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-neutral-300 focus:ring-2 focus:ring-orange-500 focus:outline-none">
              <option value="">City (All)</option>
            </select>

            <select id="filterProvince" class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-neutral-300 focus:ring-2 focus:ring-orange-500 focus:outline-none">
              <option value="">Province (All)</option>
            </select>

            <select id="filterStatus" class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-sm text-neutral-300 focus:ring-2 focus:ring-orange-500 focus:outline-none">
              <option value="">Status (All)</option>
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>

            <button onclick="applyFilters()" class="px-4 py-2 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg text-sm font-medium hover:from-orange-500 hover:to-orange-400 transition">
              Apply Filters
            </button>
          </div>
        </div>
      </section>

      <!-- Pharmacy Table -->
      <section class="px-4 sm:px-6 pb-8">
        <div class="bg-neutral-800/80 border border-neutral-700 rounded-xl shadow">
          <div class="px-4 sm:px-6 py-4 border-b border-neutral-700 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
            <h2 class="text-lg font-semibold text-white">Pharmacy List</h2>
            <button onclick="addPharmacy()" class="text-sm text-orange-400 hover:text-orange-300">+ Add Pharmacy</button>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-neutral-800 border-b border-neutral-700">
                <tr>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Name</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">City</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Province</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Status</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Total Orders</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Outstanding ($)</th>
                  <th class="px-6 py-3 text-left text-neutral-400 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="pharmacyTableBody" class="divide-y divide-neutral-700">
                <tr><td colspan="7" class="text-center text-neutral-500 py-4">Loading pharmacies...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Pharmacy Details -->
      <section id="pharmacyDetailsSection" class="px-4 sm:px-6 pb-10 grid grid-cols-1 lg:grid-cols-2 gap-6 hidden">
        <!-- Pharmacy Profile -->
        <div class="bg-neutral-800/80 border border-neutral-700 rounded-xl p-6">
          <h2 class="text-lg font-semibold text-white mb-4">Pharmacy Profile</h2>
          <div id="pharmacyProfileContent" class="space-y-3 text-sm">
            <!-- Dynamic content -->
          </div>
          <div class="flex pt-5">
            <button onclick="editPharmacyDetails()" 
              class="w-full bg-gradient-to-r from-orange-600 to-orange-500 text-white py-2 rounded-lg text-sm font-medium hover:from-orange-500 hover:to-orange-400 transition">
              Edit Details
            </button>
          </div>
          <div class="mt-6 border-t border-neutral-700 pt-4">
            <h3 class="text-sm font-semibold text-white mb-2">Account Actions</h3>
            <div class="flex flex-wrap gap-3">
              <button onclick="deactivatePharmacy()" class="flex-1 sm:flex-none text-xs text-yellow-400 border border-yellow-600/40 px-3 py-2 rounded hover:bg-yellow-600/20">Deactivate</button>
              <button onclick="reactivatePharmacy()" class="flex-1 sm:flex-none text-xs text-green-400 border border-green-600/40 px-3 py-2 rounded hover:bg-green-600/20">Reactivate</button>
              <button onclick="resetCredentials()" class="flex-1 sm:flex-none text-xs text-orange-400 border border-orange-600/40 px-3 py-2 rounded hover:bg-orange-600/20">Reset Credentials</button>
            </div>
          </div>
        </div>

        <!-- Invoices -->
        <div class="bg-neutral-800/80 border border-neutral-700 rounded-xl p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-white">Invoices</h2>

          </div>
          <div class="overflow-x-auto custom-scrollbar max-h-96">
            <table class="min-w-full text-sm">
              <thead class="bg-neutral-800 border-b border-neutral-700 sticky top-0">
                <tr>
                  <th class="px-4 py-3 text-left text-neutral-400 uppercase tracking-wider text-xs">Invoice ID</th>
                  <th class="px-4 py-3 text-left text-neutral-400 uppercase tracking-wider text-xs">Date Range</th>
                  <th class="px-4 py-3 text-left text-neutral-400 uppercase tracking-wider text-xs">Total ($)</th>
                  <th class="px-4 py-3 text-left text-neutral-400 uppercase tracking-wider text-xs">Status</th>
                  <th class="px-4 py-3 text-left text-neutral-400 uppercase tracking-wider text-xs">Actions</th>
                </tr>
              </thead>
              <tbody id="invoicesTableBody" class="divide-y divide-neutral-700">
                <!-- Dynamic content -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- View Orders Modal -->
      <div id="viewOrdersModal" class="hidden fixed inset-0 bg-black/70 flex justify-center items-center z-50 p-4">
        <div class="bg-neutral-800 rounded-xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
          <div class="px-6 py-4 border-b border-neutral-700 flex justify-between items-center">
            <h3 id="ordersModalTitle" class="text-xl font-semibold text-white">Pharmacy Orders</h3>
            <button onclick="closeModal('viewOrdersModal')" class="text-neutral-400 hover:text-white">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          
          <div id="ordersModalContent" class="flex-1 overflow-y-auto custom-scrollbar px-6 py-4"></div>
          
          <div class="px-6 py-4 border-t border-neutral-700 flex justify-end">
            <button onclick="closeModal('viewOrdersModal')" class="px-4 py-2 bg-orange-500 rounded-lg text-white hover:bg-orange-600">Close</button>
          </div>
        </div>
      </div>


      <!-- Add Pharmacy Modal -->
      <div id="addPharmacyModal" class="hidden fixed inset-0 bg-black/70 flex justify-center items-center z-50 p-4">
        <div class="bg-neutral-800 border border-neutral-700 rounded-xl w-full max-w-lg p-6">
          
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-white">Add New Pharmacy</h2>
            <button onclick="closeModal('addPharmacyModal')" class="text-neutral-400 hover:text-white">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <input id="phName" type="text" placeholder="Pharmacy Name"
              class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500"/>

            <textarea id="phAddress" placeholder="Store Address"
              class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500"></textarea>

            <div class="grid grid-cols-2 gap-3">
              <!-- City: searchable dropdown using datalist -->
              <div class="relative">
                <input
                  id="phCity"
                  type="text"
                  list="cityOptions"
                  placeholder="City (Kitchener / Waterloo / Cambridge)"
                  class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500"
                />
                <datalist id="cityOptions">
                  <option value="Kitchener"></option>
                  <option value="Waterloo"></option>
                  <option value="Cambridge"></option>
                </datalist>
              </div>

              <!-- Province: fixed Ontario -->
              <input
                id="phProvince"
                type="text"
                value="Ontario"
                readonly
                class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-400 text-sm cursor-not-allowed"
              />
            </div>


            <div class="grid grid-cols-2 gap-3">
              <input
                id="phPostal"
                type="text"
                placeholder="Postal Code"
                class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500"
              />

              <!-- Country: fixed Canada -->
              <input
                id="phCountry"
                type="text"
                value="Canada"
                readonly
                class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-400 text-sm cursor-not-allowed"
              />
            </div>

            <div class="grid grid-cols-2 gap-3">
              <input id="phPhone" type="text" placeholder="Phone Number"
                class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500"/>

              <input id="phEmail" type="email" placeholder="Email Address"
                class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500"/>
            </div>

            <!-- Business Hours Section -->
            <div class="mt-6 border-t border-neutral-700 pt-4">
              <h3 class="text-sm font-semibold text-white mb-3">Business Hours (Optional)</h3>
              <p class="text-xs text-neutral-400 mb-4">Leave empty to use default hours (Mon-Fri: 9 AM - 6 PM)</p>
              
              <div class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar">
                <!-- Monday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Mon</label>
                  <input type="checkbox" id="phMon" checked class="col-span-1" onchange="toggleDay('phMon')">
                  <input type="time" id="phMonOpen" value="09:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="phMonClose" value="18:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                </div>
                
                <!-- Tuesday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Tue</label>
                  <input type="checkbox" id="phTue" checked class="col-span-1" onchange="toggleDay('phTue')">
                  <input type="time" id="phTueOpen" value="09:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="phTueClose" value="18:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                </div>
                
                <!-- Wednesday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Wed</label>
                  <input type="checkbox" id="phWed" checked class="col-span-1" onchange="toggleDay('phWed')">
                  <input type="time" id="phWedOpen" value="09:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="phWedClose" value="18:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                </div>
                
                <!-- Thursday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Thu</label>
                  <input type="checkbox" id="phThu" checked class="col-span-1" onchange="toggleDay('phThu')">
                  <input type="time" id="phThuOpen" value="09:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="phThuClose" value="18:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                </div>
                
                <!-- Friday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Fri</label>
                  <input type="checkbox" id="phFri" checked class="col-span-1" onchange="toggleDay('phFri')">
                  <input type="time" id="phFriOpen" value="09:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="phFriClose" value="18:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                </div>
                
                <!-- Saturday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Sat</label>
                  <input type="checkbox" id="phSat" class="col-span-1" onchange="toggleDay('phSat')">
                  <input type="time" id="phSatOpen" value="09:00" disabled class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-500">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="phSatClose" value="18:00" disabled class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-500">
                </div>
                
                <!-- Sunday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Sun</label>
                  <input type="checkbox" id="phSun" class="col-span-1" onchange="toggleDay('phSun')">
                  <input type="time" id="phSunOpen" value="09:00" disabled class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-500">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="phSunClose" value="18:00" disabled class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-500">
                </div>
              </div>
            </div>
          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button onclick="closeModal('addPharmacyModal')" 
              class="px-4 py-2 text-neutral-300 border border-neutral-600 rounded-lg text-sm hover:bg-neutral-700">
              Cancel
            </button>

            <button onclick="submitAddPharmacy()" 
              class="px-4 py-2 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg text-sm font-medium hover:from-orange-500 hover:to-orange-400">
              Add Pharmacy
            </button>
          </div>

        </div>
      </div>



      <!-- Edit Pharmacy Modal -->
      <div id="editPharmacyModal" class="hidden fixed inset-0 bg-black/70 flex justify-center items-center z-50 p-4">
        <div class="bg-neutral-800 border border-neutral-700 rounded-xl w-full max-w-lg p-6">

          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-white">Edit Pharmacy</h2>
            <button onclick="closeModal('editPharmacyModal')" class="text-neutral-400 hover:text-white">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div class="space-y-4">
            <input id="editPhName" type="text" placeholder="Pharmacy Name"
              class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500"/>

            <textarea id="editPhAddress" placeholder="Store Address"
              class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500"></textarea>

            <div class="grid grid-cols-2 gap-3">
              <!-- City dropdown -->
              <div class="relative">
                <input id="editPhCity" type="text" list="cityOptions" placeholder="City"
                  class="w-full bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500" />
              </div>

              <!-- Province fixed -->
              <input id="editPhProvince" type="text" value="Ontario" readonly
                class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-400 text-sm cursor-not-allowed"/>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <input id="editPhPostal" type="text" placeholder="Postal Code"
                class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500"/>

              <!-- Country fixed -->
              <input id="editPhCountry" type="text" value="Canada" readonly
                class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-400 text-sm cursor-not-allowed"/>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <input id="editPhPhone" type="text" placeholder="Phone Number"
                class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500"/>

              <input id="editPhEmail" type="email" placeholder="Email Address"
                class="bg-neutral-900 border border-neutral-700 rounded-lg px-3 py-2 text-neutral-200 text-sm focus:ring-2 focus:ring-orange-500"/>
            </div>

            <!-- Business Hours Section -->
            <div class="mt-6 border-t border-neutral-700 pt-4">
              <h3 class="text-sm font-semibold text-white mb-3">Business Hours</h3>
              <p class="text-xs text-neutral-400 mb-4">Update pharmacy operating hours</p>
              
              <div class="space-y-3 max-h-64 overflow-y-auto custom-scrollbar">
                <!-- Monday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Mon</label>
                  <input type="checkbox" id="editPhMon" checked class="col-span-1" onchange="toggleDay('editPhMon')">
                  <input type="time" id="editPhMonOpen" value="09:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="editPhMonClose" value="18:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                </div>
                
                <!-- Tuesday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Tue</label>
                  <input type="checkbox" id="editPhTue" checked class="col-span-1" onchange="toggleDay('editPhTue')">
                  <input type="time" id="editPhTueOpen" value="09:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="editPhTueClose" value="18:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                </div>
                
                <!-- Wednesday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Wed</label>
                  <input type="checkbox" id="editPhWed" checked class="col-span-1" onchange="toggleDay('editPhWed')">
                  <input type="time" id="editPhWedOpen" value="09:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="editPhWedClose" value="18:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                </div>
                
                <!-- Thursday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Thu</label>
                  <input type="checkbox" id="editPhThu" checked class="col-span-1" onchange="toggleDay('editPhThu')">
                  <input type="time" id="editPhThuOpen" value="09:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="editPhThuClose" value="18:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                </div>
                
                <!-- Friday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Fri</label>
                  <input type="checkbox" id="editPhFri" checked class="col-span-1" onchange="toggleDay('editPhFri')">
                  <input type="time" id="editPhFriOpen" value="09:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="editPhFriClose" value="18:00" class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-200">
                </div>
                
                <!-- Saturday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Sat</label>
                  <input type="checkbox" id="editPhSat" class="col-span-1" onchange="toggleDay('editPhSat')">
                  <input type="time" id="editPhSatOpen" value="09:00" disabled class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-500">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="editPhSatClose" value="18:00" disabled class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-500">
                </div>
                
                <!-- Sunday -->
                <div class="grid grid-cols-12 gap-2 items-center">
                  <label class="col-span-2 text-sm text-neutral-300">Sun</label>
                  <input type="checkbox" id="editPhSun" class="col-span-1" onchange="toggleDay('editPhSun')">
                  <input type="time" id="editPhSunOpen" value="09:00" disabled class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-500">
                  <span class="col-span-1 text-center text-neutral-500">to</span>
                  <input type="time" id="editPhSunClose" value="18:00" disabled class="col-span-4 bg-neutral-900 border border-neutral-700 rounded px-2 py-1 text-xs text-neutral-500">
                </div>
              </div>
            </div>

          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button onclick="closeModal('editPharmacyModal')" 
              class="px-4 py-2 text-neutral-300 border border-neutral-600 rounded-lg text-sm hover:bg-neutral-700">
              Cancel
            </button>

            <button onclick="submitEditPharmacy()" 
              class="px-4 py-2 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg text-sm font-medium hover:from-orange-500 hover:to-orange-400">
              Update Pharmacy
            </button>
          </div>

        </div>
      </div>


      <!-- Toggle Pharmacy Status Modal -->
      <div id="toggleStatusModal" class="hidden fixed inset-0 bg-black/70 flex justify-center items-center z-50 p-4">
        <div class="bg-neutral-800 border border-neutral-700 rounded-xl w-full max-w-md p-6">

          <h2 id="toggleStatusTitle" class="text-xl font-semibold text-white mb-3">
            Confirm Action
          </h2>

          <p id="toggleStatusMessage" class="text-neutral-300 text-sm mb-6">
            Are you sure you want to deactivate this pharmacy?
          </p>

          <div class="flex justify-end space-x-3">
            <button onclick="closeModal('toggleStatusModal')" 
              class="px-4 py-2 text-neutral-300 border border-neutral-600 rounded-lg text-sm hover:bg-neutral-700">
              Cancel
            </button>

            <button id="toggleStatusConfirmBtn"
              class="px-4 py-2 bg-gradient-to-r from-orange-600 to-orange-500 text-white rounded-lg text-sm font-medium hover:from-orange-500 hover:to-orange-400">
              Confirm
            </button>
          </div>

        </div>
      </div>




      <script>
let allPharmacies = [];
let filteredPharmacies = [];
let currentPharmacy = null;
let editingPharmacyId = null;
let togglingPharmacyId = null;
let togglingAction = null; 


        function getCSRFToken() {
            return document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
        }

// Logout
document.getElementById("logoutBtn").addEventListener("click", function (event) {
  event.preventDefault();
  document.cookie = "adminId=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax;";
  document.cookie = "jwtToken=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax;";
  window.location.href = "/adminLogin/";
});

// Load all pharmacies on page load
async function loadPharmacies() {
  try {
    const res = await fetch("/api/pharmacy/details/");
    const data = await res.json();
    
    if (!data.success) throw new Error("Failed to load pharmacies");
    
    allPharmacies = data.pharmacies;
    filteredPharmacies = [...allPharmacies];
    
    populateFilters();
    renderPharmaciesTable();
  } catch (err) {
    console.error("Error loading pharmacies:", err);
    document.getElementById("pharmacyTableBody").innerHTML = 
      `<tr><td colspan="7" class="text-center text-red-400 py-4">Failed to load pharmacies</td></tr>`;
  }
}

// Populate filter dropdowns
function populateFilters() {
  const cities = [...new Set(allPharmacies.map(p => p.city))].sort();
  const provinces = [...new Set(allPharmacies.map(p => p.province))].sort();
  
  const citySelect = document.getElementById("filterCity");
  const provinceSelect = document.getElementById("filterProvince");
  
  cities.forEach(city => {
    const option = document.createElement("option");
    option.value = city;
    option.textContent = city;
    citySelect.appendChild(option);
  });
  
  provinces.forEach(province => {
    const option = document.createElement("option");
    option.value = province;
    option.textContent = province;
    provinceSelect.appendChild(option);
  });
}

// Apply filters
function applyFilters() {
  const search = document.getElementById("searchPharmacy").value.toLowerCase();
  const city = document.getElementById("filterCity").value;
  const province = document.getElementById("filterProvince").value;
  const status = document.getElementById("filterStatus").value;
  
  filteredPharmacies = allPharmacies.filter(p => {
    return (
      (!search || p.name.toLowerCase().includes(search) || p.email?.toLowerCase().includes(search)) &&
      (!city || p.city === city) &&
      (!province || p.province === province) &&
      (!status || p.active.toString() === status)
    );
  });
  
  renderPharmaciesTable();
}

// Render pharmacies table
function renderPharmaciesTable() {
  const tbody = document.getElementById("pharmacyTableBody");
  
  if (filteredPharmacies.length === 0) {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-neutral-500 py-4">No pharmacies found</td></tr>`;
    return;
  }
  
  tbody.innerHTML = filteredPharmacies.map(p => `
    <tr class="hover:bg-neutral-700/50 transition">
        <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-100 font-medium">${p.name}</td>
        <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-300">${p.city}</td>
        <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-300">${p.province}</td>
        <td class="px-4 sm:px-6 py-3 sm:py-4">
        <span class="inline-flex px-3 py-1 text-xs font-medium rounded-full ${p.active ? 'bg-green-500/20 text-green-400 border border-green-600/40' : 'bg-red-500/20 text-red-400 border border-red-600/40'}">
          ${p.active ? 'Active' : 'Inactive'}
        </span>
      </td>
      <td class="px-4 sm:px-6 py-3 sm:py-4 text-neutral-100">${p.total_valid_orders || 0}</td>
      <td class="px-4 sm:px-6 py-3 sm:py-4 text-orange-400 font-semibold">$${(p.total_outstanding_amount || 0).toFixed(2)}</td>
      <td class="px-4 sm:px-6 py-3 sm:py-4 space-x-2">
        <button onclick="viewPharmacy(${p.id})" class="text-xs text-orange-400 border border-orange-600/40 px-3 py-1 rounded hover:bg-orange-600/20">View</button>
        <button onclick="editPharmacy(${p.id})" class="text-xs text-neutral-300 border border-neutral-600 px-3 py-1 rounded hover:bg-neutral-700">Edit</button>
        <button onclick="togglePharmacyStatus(${p.id})" class="text-xs text-red-400 border border-red-600/40 px-3 py-1 rounded hover:bg-red-600/20">
          ${p.active ? 'Deactivate' : 'Activate'}
        </button>
      </td>
    </tr>
  `).join("");
}

// View pharmacy details
async function viewPharmacy(id) {
  try {
    const res = await fetch(`/api/pharmacy/details/${id}/`);
    const data = await res.json();
    
    if (!data.success) throw new Error("Failed to load pharmacy details");
    
    currentPharmacy = data;
    displayPharmacyDetails(data);
    
  } catch (err) {
    console.error("Error loading pharmacy details:", err);
    showNotification("❌ Failed to load pharmacy details", "error");
  }
}

function displayPharmacyDetails(data) {
  const { pharmacy, total_orders, total_outstanding_amount, orders, invoices } = data;
  
  // Show details section
  document.getElementById("pharmacyDetailsSection").classList.remove("hidden");
  
  // Populate profile
  const profileContent = document.getElementById("pharmacyProfileContent");

  // Format business hours
  let businessHoursHTML = '';
  if (pharmacy.business_hours && typeof pharmacy.business_hours === 'object') {
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    businessHoursHTML = '<div class="mt-3 p-3 bg-neutral-900/50 rounded border border-neutral-700"><p class="text-neutral-400 text-xs mb-2">Business Hours:</p>';
    
    days.forEach(day => {
      const hours = pharmacy.business_hours[day];
      if (hours && hours !== 'closed') {
        businessHoursHTML += `<p class="text-xs text-neutral-300">${day}: ${hours.open} - ${hours.close}</p>`;
      } else {
        businessHoursHTML += `<p class="text-xs text-neutral-500">${day}: Closed</p>`;
      }
    });
    
    businessHoursHTML += '</div>';
  }

  profileContent.innerHTML = `
    <p><span class="text-neutral-400">Name:</span> <span class="text-neutral-100 font-medium">${pharmacy.name}</span></p>
    <p><span class="text-neutral-400">Email:</span> ${pharmacy.email}</p>
    <p><span class="text-neutral-400">Phone:</span> ${pharmacy.phone_number}</p>
    <p><span class="text-neutral-400">Address:</span> ${pharmacy.store_address}, ${pharmacy.city}, ${pharmacy.province}, ${pharmacy.postal_code}</p>
    <p><span class="text-neutral-400">Country:</span> ${pharmacy.country}</p>
    <p><span class="text-neutral-400">Status:</span> 
      <span class="${pharmacy.active ? 'text-green-400' : 'text-red-400'}">${pharmacy.active ? 'Active' : 'Inactive'}</span>
    </p>
    ${pharmacy.cc_points ? `<p><span class="text-neutral-400">CC Points Balance:</span> <span class="text-orange-400 font-semibold">${pharmacy.cc_points.points_balance}</span></p>` : ''}
    <p><span class="text-neutral-400">Joined:</span> ${new Date(pharmacy.created_at_local).toLocaleDateString()}</p>
    <p><span class="text-neutral-400">Total Orders:</span> <span class="text-orange-400 font-semibold">${total_orders}</span></p>
    <p><span class="text-neutral-400">Outstanding:</span> <span class="text-orange-400 font-semibold">$${total_outstanding_amount.toFixed(2)}</span></p>
    ${businessHoursHTML}
  `;
  
  // Populate invoices
  const invoicesBody = document.getElementById("invoicesTableBody");
  if (invoices.length === 0) {
    invoicesBody.innerHTML = `<tr><td colspan="5" class="text-center text-neutral-500 py-4">No invoices found</td></tr>`;
  } else {
    invoicesBody.innerHTML = invoices.map(inv => `
      <tr class="hover:bg-neutral-700/50 transition">
        <td class="px-4 py-3 text-neutral-100 font-medium">INV-${inv.invoice_id}</td>
        <td class="px-4 py-3 text-neutral-300 text-xs">${new Date(inv.start_date).toLocaleDateString()} – ${new Date(inv.end_date).toLocaleDateString()}</td>
        <td class="px-4 py-3 text-neutral-100 font-semibold">$${inv.total_amount.toFixed(2)}</td>
        <td class="px-4 py-3">
          <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${getInvoiceStatusColor(inv.status)}">
            ${formatInvoiceStatus(inv.status)}
          </span>
        </td>
        <td class="px-4 py-3 space-x-2">
          ${inv.pdf_url ? `<a href="${inv.pdf_url}" target="_blank" class="text-xs text-orange-400 border border-orange-600/40 px-2 py-1 rounded hover:bg-orange-600/20">View PDF</a>` : '<span class="text-xs text-neutral-500">No PDF</span>'}
        </td>
      </tr>
    `).join("");
  }
  
  addViewOrdersButton();
  
  // Scroll to details
  document.getElementById("pharmacyDetailsSection").scrollIntoView({ behavior: "smooth" });
}

// Helper functions
function getInvoiceStatusColor(status) {
  const colors = {
    'pending': 'bg-yellow-500/20 text-yellow-400 border border-yellow-600/40',
    'paid': 'bg-green-500/20 text-green-400 border border-green-600/40',
    'past_due': 'bg-red-500/20 text-red-400 border border-red-600/40',
    'generated': 'bg-blue-500/20 text-blue-400 border border-blue-600/40'
  };
  return colors[status] || 'bg-neutral-500/20 text-neutral-400 border border-neutral-600/40';
}

function formatInvoiceStatus(status) {
  const formats = {
    'pending': 'Pending',
    'paid': 'Paid',
    'past_due': 'Past Due',
    'generated': 'Generated'
  };
  return formats[status] || status;
}

function closeModal(id) {
  document.getElementById(id).classList.add("hidden");
}

function showNotification(message, type = "success") {
  const toast = document.createElement("div");
  toast.className = `
    fixed top-6 right-6 px-4 py-3 rounded-lg text-sm shadow-lg z-50 transition transform duration-300
    ${type === "success" ? "bg-green-600 text-white" : "bg-red-600 text-white"}
  `;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(-10px)";
  }, 2500);

  setTimeout(() => toast.remove(), 3000);
}


function addPharmacy() {
  document.getElementById("addPharmacyModal").classList.remove("hidden");
}

// Edit pharmacy - works both from table and from details view
function editPharmacy(id) {
  const pharmacy = allPharmacies.find(p => p.id === id);
  if (!pharmacy) {
    showNotification("❌ Pharmacy not found", "error");
    return;
  }

  editingPharmacyId = id;

  // Pre-fill basic fields
  document.getElementById("editPhName").value = pharmacy.name;
  document.getElementById("editPhAddress").value = pharmacy.store_address;
  document.getElementById("editPhCity").value = pharmacy.city;
  document.getElementById("editPhPostal").value = pharmacy.postal_code;
  document.getElementById("editPhPhone").value = pharmacy.phone_number;
  document.getElementById("editPhEmail").value = pharmacy.email;

  // Province & country are fixed already
  document.getElementById("editPhProvince").value = "Ontario";
  document.getElementById("editPhCountry").value = "Canada";

  // Populate business hours if available
  if (pharmacy.business_hours && typeof pharmacy.business_hours === 'object') {
    const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    
    days.forEach(day => {
      const hours = pharmacy.business_hours[day];
      const checkbox = document.getElementById('editPh' + day);
      const openInput = document.getElementById('editPh' + day + 'Open');
      const closeInput = document.getElementById('editPh' + day + 'Close');
      
      if (hours && hours !== 'closed' && hours.open && hours.close) {
        checkbox.checked = true;
        openInput.value = hours.open;
        closeInput.value = hours.close;
        openInput.disabled = false;
        closeInput.disabled = false;
        openInput.classList.remove('text-neutral-500');
        closeInput.classList.remove('text-neutral-500');
        openInput.classList.add('text-neutral-200');
        closeInput.classList.add('text-neutral-200');
      } else {
        checkbox.checked = false;
        openInput.disabled = true;
        closeInput.disabled = true;
        openInput.classList.add('text-neutral-500');
        closeInput.classList.add('text-neutral-500');
        openInput.classList.remove('text-neutral-200');
        closeInput.classList.remove('text-neutral-200');
      }
    });
  } else {
    // Set default hours if no business hours exist
    const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
    const weekend = ['Sat', 'Sun'];
    
    weekdays.forEach(day => {
      document.getElementById('editPh' + day).checked = true;
      document.getElementById('editPh' + day + 'Open').value = '09:00';
      document.getElementById('editPh' + day + 'Close').value = '18:00';
      document.getElementById('editPh' + day + 'Open').disabled = false;
      document.getElementById('editPh' + day + 'Close').disabled = false;
    });
    
    weekend.forEach(day => {
      document.getElementById('editPh' + day).checked = false;
      document.getElementById('editPh' + day + 'Open').disabled = true;
      document.getElementById('editPh' + day + 'Close').disabled = true;
    });
  }

  document.getElementById("editPharmacyModal").classList.remove("hidden");
}

// Alias for editPharmacyDetails - calls the same editPharmacy function
function editPharmacyDetails() {
  if (currentPharmacy && currentPharmacy.pharmacy) {
    editPharmacy(currentPharmacy.pharmacy.id);
  } else {
    showNotification("❌ No pharmacy selected", "error");
  }
}

// Toggle pharmacy status - works from table, details view, and account actions
function togglePharmacyStatus(id, forceAction = null) {
  const pharmacy = allPharmacies.find(p => p.id === id);
  if (!pharmacy) {
    showNotification("❌ Pharmacy not found", "error");
    return;
  }

  togglingPharmacyId = id;
  // If forceAction is provided (from deactivate/reactivate), use it; otherwise determine from current status
  togglingAction = forceAction || (pharmacy.active ? "deactivate" : "activate");

  // Update modal text
  document.getElementById("toggleStatusTitle").textContent =
    `${togglingAction === "deactivate" ? "Deactivate" : "Activate"} Pharmacy`;

  document.getElementById("toggleStatusMessage").textContent =
    `Are you sure you want to ${togglingAction} ${pharmacy.name}?`;

  // Set button color dynamically
  const btn = document.getElementById("toggleStatusConfirmBtn");
  if (togglingAction === "deactivate") {
    btn.className = "px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700";
  } else {
    btn.className = "px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700";
  }

  // Open the modal
  document.getElementById("toggleStatusModal").classList.remove("hidden");
}

// Deactivate pharmacy - calls togglePharmacyStatus with forced action
function deactivatePharmacy() {
  if (currentPharmacy && currentPharmacy.pharmacy) {
    togglePharmacyStatus(currentPharmacy.pharmacy.id, "deactivate");
  } else {
    showNotification("❌ No pharmacy selected", "error");
  }
}

// Reactivate pharmacy - calls togglePharmacyStatus with forced action
function reactivatePharmacy() {
  if (currentPharmacy && currentPharmacy.pharmacy) {
    togglePharmacyStatus(currentPharmacy.pharmacy.id, "activate");
  } else {
    showNotification("❌ No pharmacy selected", "error");
  }
}


function resetCredentials() {
  if (!currentPharmacy || !currentPharmacy.pharmacy) {
    showNotification("❌ No pharmacy selected", "error");
    return;
  }

  const pharmacyId = currentPharmacy.pharmacy.id;
  const pharmacyName = currentPharmacy.pharmacy.name;

  // Set up modal for confirmation
  document.getElementById("toggleStatusTitle").textContent = "Reset Password";
  document.getElementById("toggleStatusMessage").textContent = 
    `Are you sure you want to reset the password for ${pharmacyName}?`;

  const btn = document.getElementById("toggleStatusConfirmBtn");
  btn.className = "px-4 py-2 bg-orange-600 text-white rounded-lg text-sm font-medium hover:bg-orange-700";
  
  // Override the confirm button's onclick for this specific action
  btn.onclick = async function() {
    try {
      const res = await fetch(`/pharmacy/reset-password/${pharmacyId}/`, {
        method: "PATCH",
        headers: { 
          "Content-Type": "application/json",
          "X-CSRFToken": getCSRFToken()
        },
        credentials: "include"
      });

      const data = await res.json();

      if (!data.success) {
        showNotification("❌ " + data.message, "error");
        closeModal("toggleStatusModal");
        return;
      }

      showNotification("✅ Password reset successfully!", "success");
      closeModal("toggleStatusModal");

    } catch (err) {
      console.error("Reset Credentials Error:", err);
      showNotification("❌ Failed to reset password", "error");
      closeModal("toggleStatusModal");
    }
  };

  // Open the modal
  document.getElementById("toggleStatusModal").classList.remove("hidden");
}



async function viewOrders(pharmacyId) {
  try {
    // Fetch fresh data with full details
    const res = await fetch(`/api/pharmacy/details/${pharmacyId}/`, {
      method: "GET",
      credentials: "include",
      headers: {
        "X-CSRFToken": getCSRFToken()
      }
    });
    
    const data = await res.json();
    
    if (!data.success) {
      showNotification("❌ Failed to load orders", "error");
      return;
    }

    const orders = data.orders;
    const pharmacy = data.pharmacy;
    
    document.getElementById("ordersModalTitle").textContent = `${pharmacy.name} - Orders (${orders.length})`;
    
    const modalContent = document.getElementById("ordersModalContent");
    
    if (orders.length === 0) {
      modalContent.innerHTML = `
        <div class="text-center text-neutral-500 py-8">
          <svg class="w-16 h-16 mx-auto mb-4 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
          </svg>
          <p class="text-lg">No orders found for this pharmacy</p>
        </div>
      `;
    } else {
      modalContent.innerHTML = `
        <div class="space-y-4">
          ${orders.map(order => `
            <div class="bg-neutral-900/50 rounded-lg p-4 border border-neutral-700">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <h4 class="text-lg font-semibold text-white">Order #${order.id}</h4>
                  <p class="text-sm text-neutral-400">Customer: ${order.customer_name || "N/A"}</p>
                  <p class="text-xs text-neutral-500">Phone: ${order.customer_phone || "N/A"}</p>
                  ${order.alternate_contact ? `<p class="text-xs text-neutral-500">Alt Contact: ${order.alternate_contact}</p>` : ''}
                </div>
                <span class="inline-flex px-3 py-1 text-xs font-medium rounded-full ${getOrderStatusColor(order.status)}">
                  ${formatOrderStatus(order.status)}
                </span>
              </div>
              
              ${order.delivery_notes ? `
                <div class="mb-3 p-2 bg-neutral-800/50 rounded border-l-2 border-orange-500">
                  <p class="text-xs text-neutral-400">Delivery Notes:</p>
                  <p class="text-sm text-neutral-200">${order.delivery_notes}</p>
                </div>
              ` : ''}
              
              <div class="grid grid-cols-2 gap-4 text-sm mb-3">
                <div>
                  <p class="text-neutral-400">Pickup:</p>
                  <p class="text-neutral-200">${order.pickup_address}</p>
                  <p class="text-neutral-300 text-xs">${order.pickup_city}</p>
                  <p class="text-neutral-400 text-xs mt-1">Date: ${new Date(order.pickup_day).toLocaleDateString()}</p>
                </div>
                
                <div>
                  <p class="text-neutral-400">Delivery:</p>
                  <p class="text-neutral-200">${order.drop_address}</p>
                  <p class="text-neutral-300 text-xs">${order.drop_city}</p>
                </div>
              </div>
              
              ${order.signature_required || order.id_verification_required ? `
                <div class="mb-3 flex gap-2 flex-wrap">
                  ${order.signature_required ? `
                    <button 
                      onclick="window.open('${order.signature_ack_url || '#'}', '_blank')" 
                      class="inline-flex items-center px-2 py-1 text-xs bg-blue-500/20 text-blue-400 border border-blue-600/40 rounded hover:bg-blue-600/30 transition ${!order.signature_ack_url ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}"
                      ${!order.signature_ack_url ? 'disabled' : ''}
                    >
                      📝 Signature ${order.signature_ack_url ? 'Required (View)' : 'Required (Pending)'}
                    </button>
                  ` : ''}
                  ${order.id_verification_required ? '<span class="inline-flex px-2 py-1 text-xs bg-purple-500/20 text-purple-400 border border-purple-600/40 rounded">ID Verification Required</span>' : ''}
                  ${order.id_verified ? '<span class="inline-flex px-2 py-1 text-xs bg-green-500/20 text-green-400 border border-green-600/40 rounded">✓ ID Verified</span>' : ''}
                </div>
              ` : ''}
              
              ${order.driver ? `
                <div class="mb-3 p-2 bg-neutral-800/50 rounded">
                  <p class="text-xs text-neutral-400 mb-1">Driver Information:</p>
                  <div class="flex justify-between items-start">
                    <div>
                      <p class="text-sm text-neutral-200">${order.driver.name}</p>
                      <p class="text-xs text-neutral-400">Phone: ${order.driver.phone_number}</p>
                      <p class="text-xs text-neutral-400">Vehicle: ${order.driver.vehicle_number || 'N/A'}</p>
                    </div>
                    ${order.driver.identity_url ? `
                      <button 
                        onclick="window.open('${order.driver.identity_url}', '_blank')" 
                        class="text-xs text-orange-400 border border-orange-600/40 px-2 py-1 rounded hover:bg-orange-600/20 transition"
                      >
                        View Driver ID
                      </button>
                    ` : ''}
                  </div>
                </div>
              ` : '<p class="text-sm text-yellow-400 mb-3">⚠ No driver assigned</p>'}
              
              <div class="pt-3 border-t border-neutral-700 flex justify-between items-center">
                <div class="text-sm">
                  <span class="text-neutral-400">Rate:</span>
                  <span class="text-orange-400 font-semibold ml-2">$${order.rate.toFixed(2)}</span>
                </div>
                <div class="text-right text-xs text-neutral-500">
                  ${order.is_delivered ? '<span class="text-green-400">✓ Delivered</span>' : ''}
                </div>
              </div>
              
              <div class="mt-2 text-xs text-neutral-500">
                Created: ${new Date(order.created_at_local).toLocaleString()} ${order.delivered_at_local ? `• Delivered: ${new Date(order.delivered_at_local).toLocaleString()}` : ''}
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }
    
    document.getElementById("viewOrdersModal").classList.remove("hidden");
    
  } catch (err) {
    console.error("Error loading orders:", err);
    showNotification("❌ Failed to load orders", "error");
  }
}

function getOrderStatusColor(status) {
  const colors = {
    'pending': 'bg-yellow-500/20 text-yellow-400 border border-yellow-600/40',
    'accepted': 'bg-blue-500/20 text-blue-400 border border-blue-600/40',
    'inTransit': 'bg-purple-500/20 text-purple-400 border border-purple-600/40',
    'picked_up': 'bg-indigo-500/20 text-indigo-400 border border-indigo-600/40',
    'delivered': 'bg-green-500/20 text-green-400 border border-green-600/40',
    'cancelled': 'bg-red-500/20 text-red-400 border border-red-600/40'
  };
  return colors[status] || 'bg-orange-500/20 text-orange-400 border border-orange-600/40';
}

function formatOrderStatus(status) {
  const formats = {
    'pending': 'Pending',
    'accepted': 'Accepted',
    'inTransit': 'In Transit',
    'picked_up': 'Picked Up',
    'delivered': 'Delivered',
    'cancelled': 'Cancelled'
  };
  return formats[status] || status;
}

// Add button to view orders in pharmacy profile
function addViewOrdersButton() {
  if (currentPharmacy && currentPharmacy.orders) {
    const profileContent = document.getElementById("pharmacyProfileContent");
    const viewOrdersBtn = `
      <button onclick="viewOrders(${currentPharmacy.pharmacy.id})" 
        class="w-full mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition">
        📦 View All Orders (${currentPharmacy.orders.length})
      </button>
    `;
    profileContent.innerHTML += viewOrdersBtn;
  }
}

// Toggle business hours day - works for both add and edit modals
function toggleDay(dayPrefix) {
  const checkbox = document.getElementById(dayPrefix);
  const openInput = document.getElementById(dayPrefix + 'Open');
  const closeInput = document.getElementById(dayPrefix + 'Close');
  
  if (checkbox.checked) {
    openInput.disabled = false;
    closeInput.disabled = false;
    openInput.classList.remove('text-neutral-500');
    closeInput.classList.remove('text-neutral-500');
    openInput.classList.add('text-neutral-200');
    closeInput.classList.add('text-neutral-200');
  } else {
    openInput.disabled = true;
    closeInput.disabled = true;
    openInput.classList.add('text-neutral-500');
    closeInput.classList.add('text-neutral-500');
    openInput.classList.remove('text-neutral-200');
    closeInput.classList.remove('text-neutral-200');
  }
}

// Build business hours object from edit form
function getBusinessHoursFromEditForm() {
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const businessHours = {};
  
  days.forEach(day => {
    const checkbox = document.getElementById('editPh' + day);
    if (checkbox.checked) {
      const open = document.getElementById('editPh' + day + 'Open').value;
      const close = document.getElementById('editPh' + day + 'Close').value;
      businessHours[day] = { open, close };
    } else {
      businessHours[day] = "closed";
    }
  });
  
  return businessHours;
}

// Build business hours object from add form
function getBusinessHoursFromForm() {
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const businessHours = {};
  
  days.forEach(day => {
    const checkbox = document.getElementById('ph' + day);
    if (checkbox.checked) {
      const open = document.getElementById('ph' + day + 'Open').value;
      const close = document.getElementById('ph' + day + 'Close').value;
      businessHours[day] = { open, close };
    } else {
      businessHours[day] = "closed";
    }
  });
  
  return businessHours;
}

async function submitAddPharmacy() {
  const name = document.getElementById("phName").value.trim();
  const store_address = document.getElementById("phAddress").value.trim();
  const city = document.getElementById("phCity").value.trim();
  const province = document.getElementById("phProvince").value.trim();
  const postal_code = document.getElementById("phPostal").value.trim();
  const country = document.getElementById("phCountry").value.trim();
  const phone_number = document.getElementById("phPhone").value.trim();
  const email = document.getElementById("phEmail").value.trim();

  if (!name || !store_address || !city || !province || !postal_code || !country || !phone_number || !email) {
    showNotification("⚠️ All fields are required", "error");
    return;
  }

  // Get business hours (optional - will use defaults if not modified)
  const business_hours = getBusinessHoursFromForm();

  try {
    const res = await fetch("/pharmacy/add/", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      credentials: "include",
      body: JSON.stringify({
        name,
        store_address,
        city,
        province,
        postal_code,
        country,
        phone_number,
        email,
        business_hours
      })
    });

    const data = await res.json();

    if (!data.success) {
      showNotification("❌ " + (data.error || data.message), "error");
      return;
    }

    showNotification("✅ Pharmacy added successfully!", "success");
    closeModal("addPharmacyModal");
    
    // Clear form
    document.getElementById("phName").value = "";
    document.getElementById("phAddress").value = "";
    document.getElementById("phCity").value = "";
    document.getElementById("phPostal").value = "";
    document.getElementById("phPhone").value = "";
    document.getElementById("phEmail").value = "";
    
    loadPharmacies();

  } catch (err) {
    console.error("Error adding pharmacy:", err);
    showNotification("❌ Failed to add pharmacy", "error");
  }
}

async function submitEditPharmacy() {
  if (!editingPharmacyId) {
    showNotification("❌ Invalid pharmacy ID", "error");
    return;
  }

  const payload = {
    name: document.getElementById("editPhName").value.trim(),
    store_address: document.getElementById("editPhAddress").value.trim(),
    city: document.getElementById("editPhCity").value.trim(),
    province: document.getElementById("editPhProvince").value.trim(),
    postal_code: document.getElementById("editPhPostal").value.trim(),
    country: document.getElementById("editPhCountry").value.trim(),
    phone_number: document.getElementById("editPhPhone").value.trim(),
    email: document.getElementById("editPhEmail").value.trim(),
    business_hours: getBusinessHoursFromEditForm() // Add business hours
  };

  // Validate required fields
  if (!payload.name || !payload.store_address || !payload.city || !payload.postal_code || !payload.phone_number || !payload.email) {
    showNotification("⚠️ All fields are required", "error");
    return;
  }

  try {
    const res = await fetch(`/pharmacy/edit/${editingPharmacyId}/`, {
      method: "PUT",
      headers: { 
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      credentials: "include",
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!data.success) {
      showNotification("❌ " + (data.error || data.message), "error");
      return;
    }

    showNotification("✅ Pharmacy updated successfully!", "success");
    closeModal("editPharmacyModal");
    
    // Reload table and refresh current pharmacy details if viewing
    await loadPharmacies();
    if (currentPharmacy && currentPharmacy.pharmacy.id === editingPharmacyId) {
      await viewPharmacy(editingPharmacyId);
    }

  } catch (err) {
    console.error("Edit error:", err);
    showNotification("❌ Failed to update pharmacy", "error");
  }
}
// Toggle status confirmation handler
// Toggle status confirmation handler
document.getElementById("toggleStatusConfirmBtn").onclick = async function () {
  if (!togglingPharmacyId) {
    showNotification("❌ Invalid pharmacy ID", "error");
    return;
  }

  try {
    const res = await fetch(`/pharmacy/toggle-status/${togglingPharmacyId}/`, {
      method: "PATCH",
      headers: { 
        "Content-Type": "application/json",
        "X-CSRFToken": getCSRFToken()
      },
      credentials: "include"
      // No body needed - API will toggle automatically
    });

    const data = await res.json();

    if (!data.success) {
      showNotification("❌ " + (data.error || data.message), "error");
      return;
    }

    showNotification(
      `✅ Pharmacy ${togglingAction === "activate" ? "activated" : "deactivated"} successfully!`,
      "success"
    );

    closeModal("toggleStatusModal");
    
    // Reload table and refresh current pharmacy details if viewing
    await loadPharmacies();
    if (currentPharmacy && currentPharmacy.pharmacy.id === togglingPharmacyId) {
      await viewPharmacy(togglingPharmacyId);
    }

  } catch (err) {
    console.error("Toggle Status Error:", err);
    showNotification("❌ Failed to update pharmacy status", "error");
  }
};

// Initialize on page load
document.addEventListener("DOMContentLoaded", () => {
  loadPharmacies();
  
  // Add real-time search
  document.getElementById("searchPharmacy").addEventListener("input", applyFilters);
});

// Mobile menu toggle
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const sidebarOverlay = document.getElementById('sidebarOverlay');

menuToggle?.addEventListener('click', () => {
  sidebar.classList.toggle('-translate-x-full');
  sidebarOverlay.classList.toggle('hidden');
});

sidebarOverlay?.addEventListener('click', () => {
  sidebar.classList.add('-translate-x-full');
  sidebarOverlay.classList.add('hidden');
});

      </script>
    </main>
  </div>
</body>
</html>