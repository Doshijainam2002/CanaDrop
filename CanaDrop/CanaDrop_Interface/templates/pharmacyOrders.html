<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Dashboard - Orders</title>
    <link rel="icon" href="https://canalogistix.s3.us-east-2.amazonaws.com/Logo/CanaLogistiX_Logo_BG.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                        'rotate': 'rotate 0.2s ease-out'
                    }
                }
            }
        }
    </script>
    <style>
    body { font-family: 'Inter', sans-serif; }

    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Prevent horizontal overflow on mobile */
    @media (max-width: 640px) {
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }
        
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
        }
        
        main {
            overflow-x: hidden;
            max-width: 100vw;
        }
    }
</style>
</head>
<body class="min-h-screen bg-gray-50">
<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 bg-white border-r border-gray-200 flex flex-col fixed lg:static inset-y-0 left-0 z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 overflow-y-auto">

        <!-- Logo -->
        <div class="flex items-center h-16 px-6 border-b border-gray-200">
            <div class="flex items-center">
                <img src="https://canalogistix.s3.us-east-2.amazonaws.com/Logo/CanaLogistiX_Logo_NOBG.png" alt="Logo" class="h-12 w-auto">
                <span class="ml-2 text-lg font-semibold text-gray-900">CanaLogistiX</span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-4 py-6 space-y-2">
            <!-- Dashboard -->
            <a href="/pharmacyDashboard/" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M13 5v6h6"/>
                </svg>
                Dashboard
            </a>

            <!-- Orders -->
            <a href="/pharmacyOrders/" class="flex items-center px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-teal-600 to-cyan-600 rounded-lg">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v8m-6 0a2 2 0 002 2h2a2 2 0 002-2"/>
                </svg>
                Orders
            </a>

            <!-- Invoices -->
            <a href="/pharmacyInvoices/" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 4H7a2 2 0 01-2-2V6a2 2 0 012-2h7l5 5v9a2 2 0 01-2 2z"/>
                </svg>
                Invoices
            </a>

            <!-- Contact Admin -->
            <a href="/contactAdmin/" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8s-9-3.582-9-8 4.03-8 9-8 9 3.582 9 8zM12 14v-4m0 4h.01"/>
                </svg>
                Contact Admin
            </a>

            <a href="/pharmacyProfile/" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                My Profile
            </a>

            <!-- CC Points -->
            <a href="/pharmacyCCPoints/" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                CC Points
            </a>

            <!-- Logout -->
            <a href="javascript:void(0);" onclick="logoutPharmacy()" 
            class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h6a2 2 0 012 2v1"/>
                </svg>
                Logout
            </a>
        </nav>

        <!-- User Profile -->
        <div class="px-4 py-4 border-t border-gray-200">
            <div class="flex items-center">
                <div class="flex-shrink-0 w-8 h-8 bg-gradient-to-r from-teal-500 to-cyan-500 rounded-full flex items-center justify-center">
                    <span class="text-sm font-medium text-white" id="pharmacyInitial">P</span>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-900" id="pharmacyName">Pharmacy Admin</p>
                    <p class="text-xs text-gray-500" id="pharmacyEmail">admin@pharmacy.com</p>
                </div>
            </div>
        </div>
    </aside>

    <div id="sidebarOverlay" class="hidden lg:hidden fixed inset-0 bg-black/50 z-30"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-y-auto lg:ml-0">
        <!-- Top Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="px-4 sm:px-6 py-4 flex items-center justify-between gap-4">
                <!-- Hamburger Menu Button -->
                <button id="mobileMenuBtn" class="lg:hidden text-gray-600 p-2 flex-shrink-0">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                
                <div class="flex-1 min-w-0">
                    <h1 class="text-xl sm:text-2xl font-bold text-gray-900 truncate">Orders</h1>
                    <p class="text-sm text-gray-500 hidden sm:block">Manage your delivery orders</p>
                </div>
                <div class="flex items-center space-x-2 md:space-x-3">
                    <button onclick="refreshOrders()" class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <section class="p-4 sm:p-6">
            <!-- Orders List -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                <!-- Search & Filter Controls -->
                <div class="px-6 py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 bg-white rounded-t-xl border-b border-gray-100">
                    <!-- Search Bar -->
                    <div class="relative w-full sm:w-1/2">
                        <input id="searchInput" type="text"
                            placeholder="Search orders..."
                            class="w-full pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition" />
                        <svg class="w-4 h-4 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M9.5 17a7.5 7.5 0 110-15 7.5 7.5 0 010 15z" />
                        </svg>
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <select id="statusFilter"
                            class="border border-gray-300 text-sm rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent transition">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="accepted">Accepted</option>
                            <option value="inTransit">In Transit</option>
                            <option value="picked_up">Picked Up</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <!-- Header - Desktop Only -->
                <div class="hidden lg:block px-6 py-4 border-b border-gray-100">
                    <div class="grid grid-cols-12 gap-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                        <div class="col-span-2">Order ID</div>
                        <div class="col-span-2">Customer Name</div>
                        <div class="col-span-3">Addresses</div>
                        <div class="col-span-2">City & Date</div>
                        <div class="col-span-1">Status</div>
                        <div class="col-span-1">Rate</div>
                        <div class="col-span-1">Images</div>
                    </div>
                </div>

                <!-- Order Rows -->
                <div id="ordersList"></div>

                <!-- Pagination Controls -->
                <div id="paginationControls" class="flex justify-center items-center py-4 space-x-3 bg-white border-t border-gray-100 rounded-b-xl">
                    <button id="prevPage" class="px-3 py-1 text-sm rounded-md bg-gray-100 hover:bg-gray-200 disabled:opacity-50">Previous</button>
                    <span id="pageInfo" class="text-sm text-gray-600"></span>
                    <button id="nextPage" class="px-3 py-1 text-sm rounded-md bg-gray-100 hover:bg-gray-200 disabled:opacity-50">Next</button>
                </div>
            </div>
        </section>
    </main>
</div>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-hidden">
            <div class="flex items-center justify-between p-4 border-b border-gray-200">
                <div>
                    <h3 id="modalTitle" class="text-lg font-semibold text-gray-900"></h3>
                    <p id="modalTimestamp" class="text-sm text-gray-500"></p>
                </div>
                <button onclick="closeImageModal()" class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-4">
                <img id="modalImage" src="" alt="" class="w-full h-auto rounded-lg">
            </div>
        </div>
    </div>

    <script>



  // User's time zone
  function userTimeZone() {
    return Intl.DateTimeFormat().resolvedOptions().timeZone;
  }

  function normalizeUtc(isoLike) {
    if (!isoLike) return null;
    let s = String(isoLike).trim();
    // already tz-tagged
    if (/[zZ]$/.test(s) || /[+\-]\d{2}:\d{2}$/.test(s)) return s;
    // space -> T
    if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}(\.\d+)?$/.test(s)) s = s.replace(' ', 'T');
    // plain datetime without tz -> append Z (treat as UTC)
    if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?$/.test(s)) s = s + 'Z';
    return s;
  }

  // Robust date-only formatter: if a datetime slips in, we strip time part first
  function formatPlainDate(s, locale = undefined) {
    if (!s) return 'N/A';
    const raw = String(s).trim();
    const dateOnly = raw.includes('T') || raw.includes(' ')
      ? raw.split(/[T ]/)[0]
      : raw;

    const parts = dateOnly.split('-').map(Number);
    if (parts.length !== 3 || parts.some(Number.isNaN)) return 'N/A';

    const [y, m, d] = parts;
    // Render as a calendar date without timezone shifting
    const dt = new Date(Date.UTC(y, m - 1, d));
    if (isNaN(dt)) return 'N/A';

    return new Intl.DateTimeFormat(locale, {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      timeZone: 'UTC'
    }).format(dt);
  }

  function formatUtcToLocal(utcString, opts = { dateStyle: 'medium', timeStyle: 'short', hour12: true }) {
    const norm = normalizeUtc(utcString);
    if (!norm) return 'N/A';
    const d = new Date(norm);
    if (isNaN(d)) return 'N/A';
    return new Intl.DateTimeFormat(undefined, { timeZone: userTimeZone(), ...opts }).format(d);
  }


// Global variables
let currentPharmacyId = null;
let currentPharmacyName = null;
let ordersData = [];

// Utility function to get cookie value
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize page on DOM load
document.addEventListener('DOMContentLoaded', function() {
    
    
    // Get pharmacy ID from cookies
    currentPharmacyId = getCookie('pharmacyId');
    currentPharmacyName = getCookie('pharmacyName') || 'Unknown Pharmacy';
    

    
    if (!currentPharmacyId) {
        console.error('No pharmacy ID found in cookies');
        showError('Pharmacy ID not found. Please login again.');
        return;
    }
    
    // Load orders on page load
    
    loadPharmacyOrders();

// Mobile menu event listeners
const mobileMenuBtn = document.getElementById('mobileMenuBtn');
const sidebarOverlay = document.getElementById('sidebarOverlay');

if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.toggle('-translate-x-full');
        overlay.classList.toggle('hidden');
    });
}

if (sidebarOverlay) {
    sidebarOverlay.addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
    });
}

// Close mobile menu when clicking on nav links
const navLinks = document.querySelectorAll('#sidebar nav a');
navLinks.forEach(link => {
    link.addEventListener('click', () => {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('hidden');
    });
});
});

// Load pharmacy orders from API
async function loadPharmacyOrders() {
    try {
        
        showLoading(true);
        
        const apiUrl = `/api/pharmacy/${currentPharmacyId}/orders/`;
        
        
        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        

        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Response error text:', errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
       
        
        if (data.success) {
            ordersData = data.orders;
            
            ordersData = data.orders;
            filteredOrders = [...ordersData];
            renderPaginatedOrders();

        } else {
            console.error('API returned success=false:', data.error);
            throw new Error(data.error || 'Failed to load orders');
        }
        
    } catch (error) {
        console.error('Error loading orders:', error);
        console.error('Error stack:', error.stack);
        showError('Failed to load orders: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Helper function to get status badge (add this before renderOrders function)
function getStatusBadge(status) {
  const statusColorMap = {
    'pending': 'bg-yellow-100 text-yellow-700 border-yellow-200',
    'accepted': 'bg-blue-100 text-blue-700 border-blue-200',
    'inTransit': 'bg-indigo-100 text-indigo-700 border-indigo-200',
    'picked_up': 'bg-purple-100 text-purple-700 border-purple-200',
    'delivered': 'bg-green-100 text-green-700 border-green-200',
    'cancelled': 'bg-red-100 text-red-700 border-red-200'
  };

  return `<span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${statusColorMap[status] || 'bg-gray-100 text-gray-700 border-gray-200'}">${capitalizeFirst(status)}</span>`;
}


// Render orders in the UI
function renderOrders(orders) {
  const ordersList = document.getElementById('ordersList');
  if (!ordersList) return console.error('Orders list container not found');

  if (!orders || orders.length === 0) {
    ordersList.innerHTML = `
      <div class="text-center py-12">
        <div class="text-gray-400 mb-4">
          <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2M4 13h2m13-8l-7 7-7-7"/>
          </svg>
        </div>
        <p class="text-gray-500">No orders found</p>
      </div>`;
    return;
  }

  let ordersHtml = '';

  orders.forEach(order => {
    const hasHandoverImage = !!(order.images && order.images.handover && order.images.handover.length > 0);
    const rowColorClass = hasHandoverImage ? 'hover:bg-gray-50' : 'bg-red-50 hover:bg-red-100';
    const imageCountColor = order.total_images > 0 ? 'text-green-600' : 'text-red-500';

    ordersHtml += `
      <div class="border-b border-gray-50 last:border-b-0">
        <!-- Main Row -->
        <div id="row-order-${order.id}"
             class="px-4 lg:px-6 py-4 ${rowColorClass} cursor-pointer transition-colors"
             onclick="toggleOrderDetails('order-${order.id}')">

          <!-- Mobile Layout -->
          <div class="lg:hidden space-y-3">
            <div class="flex justify-between items-start">
              <div>
                <p class="text-sm font-mono font-medium text-gray-900">#${order.id}</p>
                <p class="text-xs text-gray-500">${order.customer_name || 'N/A'}</p>
                <p class="text-xs text-gray-500">${formatDateTime(order.created_at)}</p>
              </div>
              <div class="flex items-center space-x-3">
                ${getStatusBadge(order.status)}
                <svg id="arrow-order-${order.id}" class="w-4 h-4 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
            </div>

            <div class="space-y-2">
              <div>
                <p class="text-xs text-gray-500 mb-1">From:</p>
                <p class="text-sm text-gray-900">${order.pickup_address}</p>
              </div>
              <div>
                <p class="text-xs text-gray-500 mb-1">To:</p>
                <p class="text-sm text-gray-900">${order.drop_address}, ${order.drop_city}</p>
              </div>
            </div>

            <div class="flex justify-between items-center pt-2 border-t border-gray-100">
              <div>
                <p class="text-xs text-gray-500">Pickup Date</p>
                <p class="text-sm text-gray-900">${formatDate(order.pickup_day)}</p>
              </div>
              <div class="text-right">
                <p class="text-sm font-semibold text-green-600">$${parseFloat(order.rate).toFixed(2)}</p>
                <div class="flex items-center space-x-1 justify-end mt-1">
                  <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 002 2z"/>
                  </svg>
                  <span class="text-xs ${imageCountColor}">${order.total_images}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Desktop Layout -->
          <div class="hidden lg:grid lg:grid-cols-12 gap-4 items-center">
            <!-- Order ID (2) -->
            <div class="col-span-2">
              <p class="text-sm font-mono font-medium text-gray-900">#${order.id}</p>
              <p class="text-xs text-gray-500">${formatDateTime(order.created_at)}</p>
            </div>

            <!-- Customer Name (2) -->
            <div class="col-span-2">
              <p class="text-sm text-gray-900 truncate">${order.customer_name || 'N/A'}</p>
            </div>

            <!-- Addresses (3) -->
            <div class="col-span-3">
              <p class="text-sm text-gray-900 truncate">From: ${order.pickup_address}</p>
              <p class="text-xs text-gray-500 truncate">To: ${order.drop_address}</p>
            </div>

            <!-- City & Date (2) -->
            <div class="col-span-2">
              <p class="text-sm text-gray-900">${order.drop_city}</p>
              <p class="text-xs text-gray-500">${formatDate(order.pickup_day)}</p>
            </div>

            <!-- Status (1) -->
            <div class="col-span-1">
              ${getStatusBadge(order.status)}
            </div>

            <!-- Rate (1) -->
            <div class="col-span-1">
              <p class="text-sm font-semibold text-green-600">$${parseFloat(order.rate).toFixed(2)}</p>
            </div>

            <!-- Images + Arrow (1) -->
            <div class="col-span-1 flex items-center justify-end space-x-2">
              <div class="flex items-center space-x-1">
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 002 2z"/>
                </svg>
                <span id="images-count-${order.id}" class="text-xs ${imageCountColor}">${order.total_images}</span>
              </div>
              <svg id="arrow-order-${order.id}" class="w-4 h-4 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Expanded Details -->
        <div id="details-order-${order.id}" class="hidden bg-gray-50 px-4 lg:px-6 py-6 border-t border-gray-100">
          ${renderOrderDetails(order)}
        </div>
      </div>`;
  });

  ordersList.innerHTML = ordersHtml;
}


// Pagination & Filtering Variables
let currentPage = 1;
const itemsPerPage = 10;
let filteredOrders = [];

document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("searchInput");
  const statusFilter = document.getElementById("statusFilter");

  if (searchInput) {
    searchInput.addEventListener("input", applyFilters);
  }
  if (statusFilter) {
    statusFilter.addEventListener("change", applyFilters);
  }

  // Pagination buttons
  const prevBtn = document.getElementById("prevPage");
  const nextBtn = document.getElementById("nextPage");

  if (prevBtn && nextBtn) {
    prevBtn.addEventListener("click", () => changePage(-1));
    nextBtn.addEventListener("click", () => changePage(1));
  }
});

function applyFilters() {
  const searchTerm = document.getElementById("searchInput").value.toLowerCase();
  const statusValue = document.getElementById("statusFilter").value;

  filteredOrders = ordersData.filter(order => {
    const matchesSearch =
      !searchTerm ||
      Object.values(order).some(v => String(v).toLowerCase().includes(searchTerm));

    const matchesStatus = !statusValue || order.status === statusValue;

    return matchesSearch && matchesStatus;
  });

  currentPage = 1;
  renderPaginatedOrders();
}

function renderPaginatedOrders() {
  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const paginatedOrders = filteredOrders.slice(start, end);

  renderOrders(paginatedOrders);
  updatePaginationControls();
}

function updatePaginationControls() {
  const totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
  const prevBtn = document.getElementById("prevPage");
  const nextBtn = document.getElementById("nextPage");
  const pageInfo = document.getElementById("pageInfo");

  if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
  if (prevBtn) prevBtn.disabled = currentPage === 1;
  if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
}

function changePage(offset) {
  const totalPages = Math.ceil(filteredOrders.length / itemsPerPage);
  currentPage = Math.min(Math.max(1, currentPage + offset), totalPages);
  renderPaginatedOrders();
}



// Replace your entire renderOrderDetails function with this updated version

function renderOrderDetails(order) {
    const timelineHtml = order.timeline ? order.timeline.map(entry => `
        <div class="flex items-center">
            <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
            <div class="flex-1">
                <p class="text-sm font-medium text-gray-900">${capitalizeFirst(entry.step.replace('_', ' '))}</p>
                <p class="text-xs text-gray-500">${formatDateTime(entry.timestamp)}</p>
                ${entry.note ? `<p class="text-xs text-gray-400">${entry.note}</p>` : ''}
            </div>
        </div>
    `).join('') : '<p class="text-sm text-gray-500">No timeline available</p>';

    const handoverImagesHtml = renderImages(order.images ? order.images.handover : [], 'handover');
    const pickupImagesHtml = renderImages(order.images ? order.images.pickup : [], 'pickup');
    const deliveredImagesHtml = renderImages(order.images ? order.images.delivered : [], 'delivered');

    const hasHandoverImage = order.images && order.images.handover && order.images.handover.length > 0;
    const handoverCountText = hasHandoverImage ? `${order.images.handover.length} Image${order.images.handover.length > 1 ? 's' : ''}` : 'No Image';
    const handoverCountColor = hasHandoverImage ? 'text-green-600' : 'text-red-500';

    const canReplacePhoto = !['picked_up', 'delivered', 'cancelled'].includes(order.status);

    return `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Order Details + Delivery Partner + Timeline -->
            <div class="space-y-6">
                <!-- Order Information -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Order Information</h4>

                    <div class="space-y-3">
                        <div>
                            <label class="text-xs font-medium text-gray-500">Pickup Address</label>
                            <p class="text-sm text-gray-900">${order.pickup_address}</p>
                        </div>

                        <div>
                            <label class="text-xs font-medium text-gray-500">Drop Address</label>
                            <p class="text-sm text-gray-900">${order.drop_address}</p>
                        </div>

                        <!-- Customer Phone & Alternate Contact (Side by Side) -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium text-gray-500">Customer Phone</label>
                                <p class="text-sm text-gray-900">${order.customer_phone || 'N/A'}</p>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500">Alternate Contact</label>
                                <p class="text-sm text-gray-900">${order.alternate_contact || 'N/A'}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-medium text-gray-500">Drop City</label>
                                <p class="text-sm text-gray-900">${order.drop_city}</p>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500">Pickup Day</label>
                                <p class="text-sm text-gray-900">${formatDate(order.pickup_day)}</p>
                            </div>
                        </div>

                        <!-- Compliance Requirements -->
                        <div class="pt-3 border-t border-gray-100">
                            <label class="text-xs font-medium text-gray-500 mb-2 block">Delivery Requirements</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="flex items-center space-x-2">
                                    ${order.signature_required ? 
                                        '<svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' :
                                        '<svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>'
                                    }
                                    <span class="text-xs ${order.signature_required ? 'text-gray-900' : 'text-gray-500'}">Signature Required</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${order.id_verification_required ? 
                                        '<svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' :
                                        '<svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>'
                                    }
                                    <span class="text-xs ${order.id_verification_required ? 'text-gray-900' : 'text-gray-500'}">ID Verification</span>
                                </div>
                            </div>
                        </div>

                        <!-- Delivery Notes -->
                        ${order.delivery_notes ? `
                            <div class="pt-3 border-t border-gray-100">
                                <label class="text-xs font-medium text-gray-500">Delivery Notes</label>
                                <p class="text-sm text-gray-900 mt-1 p-2 bg-yellow-50 border border-yellow-200 rounded">${order.delivery_notes}</p>
                            </div>
                        ` : ''}

                        <!-- Signed Acknowledgement -->
                        ${order.signature_required && order.signature_ack_url ? `
                            <div class="pt-3 border-t border-gray-100">
                                <label class="text-xs font-medium text-gray-500 mb-2 block">Customer Signature Acknowledgement</label>
                                <a href="${order.signature_ack_url}" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                class="inline-flex items-center space-x-2 px-4 py-2 bg-gradient-to-r from-teal-600 to-cyan-600 hover:from-teal-700 hover:to-cyan-700 text-white text-sm font-medium rounded-lg transition-all duration-200 shadow-sm hover:shadow-md">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <span>View Signed Acknowledgement</span>
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                    </svg>
                                </a>
                                <p class="text-xs text-gray-500 mt-2">
                                    <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    Customer has signed to acknowledge receipt of medicines in proper condition
                                </p>
                            </div>
                        ` : order.signature_required ? `
                            <div class="pt-3 border-t border-gray-100">
                                <label class="text-xs font-medium text-gray-500 mb-2 block">Customer Signature Acknowledgement</label>
                                <div class="flex items-center space-x-2 px-4 py-2 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <svg class="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="text-sm text-yellow-700">Awaiting customer signature upon delivery</span>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Customer ID Verification Status -->
                        ${order.id_verification_required ? `
                            <div class="pt-3 border-t border-gray-100">
                                <label class="text-xs font-medium text-gray-500 mb-2 block">Customer ID Verification</label>
                                ${order.id_verified ? `
                                    <div class="flex items-center space-x-2 px-4 py-2 bg-green-50 border border-green-200 rounded-lg">
                                        <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                        </svg>
                                        <div class="flex-1">
                                            <span class="text-sm font-medium text-green-700">Completed</span>
                                            <p class="text-xs text-green-600 mt-0.5">Driver verified customer ID successfully</p>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="flex items-center space-x-2 px-4 py-2 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <div class="flex-1">
                                            <span class="text-sm font-medium text-yellow-700">Not Completed</span>
                                            <p class="text-xs text-yellow-600 mt-0.5">Awaiting driver to verify customer ID</p>
                                        </div>
                                    </div>
                                `}
                            </div>
                        ` : ''}
                    </div>
                </div>


                <!-- Delivery Partner Section -->
                ${order.driver ? `
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-teal-500">
                        <h4 class="text-sm font-semibold text-gray-900 mb-3">Delivery Partner</h4>
                        
                        <!-- Security Warning -->
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                            <div class="flex items-start space-x-2">
                                <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                                <div>
                                    <p class="text-xs font-semibold text-red-800">Security Notice</p>
                                    <p class="text-xs text-red-700 mt-1">Always verify driver identity and check their ID before handing out medicines. Confirm vehicle details match.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Driver Details with Photo -->
                        <div class="flex flex-col sm:flex-row gap-4">
                            <!-- Driver Photo -->
                            <div class="flex-shrink-0 flex justify-center sm:justify-start">
                                <div class="relative group">
                                    <div class="w-24 h-24 sm:w-28 sm:h-28 bg-gray-100 rounded-lg border-2 border-teal-500/30 flex items-center justify-center overflow-hidden">
                                        ${order.driver.identity_url ? `
                                            <img src="${order.driver.identity_url}" 
                                                alt="${order.driver.name}" 
                                                class="w-full h-full object-cover cursor-pointer hover:opacity-90 transition-opacity"
                                                onclick="openImageModal('${order.driver.identity_url}', 'Driver ID - ${order.driver.name}', 'Verify this person before handover')"
                                                onerror="this.onerror=null; this.parentElement.innerHTML='<svg class=\\'w-12 h-12 text-gray-400\\' fill=\\'currentColor\\' viewBox=\\'0 0 20 20\\'><path fill-rule=\\'evenodd\\' d=\\'M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z\\' clip-rule=\\'evenodd\\'/></svg>';" />
                                        ` : `
                                            <svg class="w-12 h-12 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                            </svg>
                                        `}
                                    </div>
                                    ${order.driver.identity_url ? `
                                        <div class="absolute -bottom-1 -right-1">
                                            <div class="px-2 py-0.5 bg-green-500 text-white text-xs font-semibold rounded-full border-2 border-white flex items-center space-x-1">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                                </svg>
                                                <span>ID</span>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Driver Info -->
                            <div class="flex-1 space-y-3">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-medium text-gray-500">Driver ID</label>
                                        <p class="text-sm font-mono font-semibold text-gray-900">#${order.driver.id}</p>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-gray-500">Status</label>
                                        <p class="text-sm">
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${order.driver.active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                                ${order.driver.active ? 'Active' : 'Inactive'}
                                            </span>
                                        </p>
                                    </div>
                                </div>

                                <div>
                                    <label class="text-xs font-medium text-gray-500">Driver Name</label>
                                    <p class="text-sm text-gray-900 font-medium">${order.driver.name}</p>
                                </div>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-medium text-gray-500">Phone Number</label>
                                        <p class="text-sm text-gray-900">
                                            <a href="tel:${order.driver.phone_number}" class="text-teal-600 hover:text-teal-700">
                                                ${order.driver.phone_number}
                                            </a>
                                        </p>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-gray-500">Vehicle Number</label>
                                        <p class="text-sm text-gray-900 font-mono">${order.driver.vehicle_number || 'N/A'}</p>
                                    </div>
                                </div>

                                <div>
                                    <label class="text-xs font-medium text-gray-500">Email</label>
                                    <p class="text-sm text-gray-900 break-all">
                                        <a href="mailto:${order.driver.email}" class="text-teal-600 hover:text-teal-700">
                                            ${order.driver.email}
                                        </a>
                                    </p>
                                </div>

                                ${order.driver.identity_url ? `
                                    <div class="pt-2 border-t border-gray-100">
                                        <button onclick="openImageModal('${order.driver.identity_url}', 'Driver ID - ${order.driver.name}', 'Verify this person before handover')"
                                                class="text-xs text-teal-600 hover:text-teal-700 font-medium flex items-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                            </svg>
                                            <span>View Full ID Photo</span>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                ` : `
                    <div class="bg-white rounded-lg p-4 shadow-sm border-l-4 border-gray-300">
                        <h4 class="text-sm font-semibold text-gray-900 mb-3">Delivery Partner</h4>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <svg class="w-12 h-12 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            <p class="text-sm text-gray-500">No driver assigned yet</p>
                            <p class="text-xs text-gray-400 mt-1">Driver will be assigned once order is accepted</p>
                        </div>
                    </div>
                `}

                <!-- Timeline -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Timeline</h4>
                    <div class="space-y-3">
                        ${timelineHtml}
                    </div>
                </div>
            </div>

            <!-- Right Column: Progress + Images -->
            <div class="space-y-6">
                <!-- Progress Bar -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Order Progress</h4>
                    <div class="relative">
                        <div class="absolute top-2 left-0 w-full h-0.5 bg-gray-200"></div>
                        <div class="absolute top-2 left-0 h-0.5 bg-gradient-to-r from-teal-500 to-cyan-500" style="width: ${order.progress_percentage}%"></div>
                        <div class="relative flex justify-between">
                            ${renderProgressSteps(order.status)}
                        </div>
                    </div>
                </div>

                <!-- Images -->
                <div class="bg-white rounded-lg p-4 shadow-sm">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">Images</h4>
                    <div class="space-y-6">
                        <!-- Handover Images -->
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-medium text-gray-700">Pharmacy Handover</span>
                                <div class="flex items-center space-x-2">
                                    <span id="handover-count-${order.id}" class="text-xs ${handoverCountColor}">${handoverCountText}</span>
                                    ${order.status === 'accepted' ? `
                                        <button onclick="triggerFileUpload('${order.id}')" 
                                            class="text-xs text-teal-600 hover:text-teal-700 font-medium">
                                            ${hasHandoverImage ? 'Replace Photo' : '+ Add Photo'}
                                        </button>
                                    ` : `
                                        <span class="text-xs text-gray-400">
                                            ${hasHandoverImage ? 'Photo Locked' : 'Add Photo Disabled'}
                                        </span>
                                    `}
                                </div>
                            </div>
                            ${order.status === 'accepted' ? 
                                `<input type="file" id="handover-upload-${order.id}" accept="image/*" class="hidden" onchange="handleImageUpload(event, '${order.id}', '${order.driver_id || ''}')">` 
                                : ''}
                            <div id="handover-images-${order.id}" 
                                class="w-full h-48 border-2 border-dashed ${hasHandoverImage ? 'border-gray-200' : 'border-gray-300'} 
                                        rounded-lg flex items-center justify-center">
                                ${hasHandoverImage ? handoverImagesHtml : '<span class="text-sm text-gray-400">No handover image</span>'}
                            </div>
                        </div>
                        
                        <!-- Driver Pickup Images -->
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-medium text-gray-700">Driver Pickup</span>
                                <span id="pickup-count-${order.id}" class="text-xs text-gray-500">${(order.images && order.images.pickup) ? (order.images.pickup.length > 0 ? order.images.pickup.length + ' Images' : 'No Images') : 'No Images'}</span>
                            </div>
                            <div id="pickup-images-${order.id}" class="w-full h-48 border-2 border-dashed border-gray-200 rounded-lg flex items-center justify-center">
                                ${(order.images && order.images.pickup && order.images.pickup.length > 0) ? pickupImagesHtml : '<span class="text-sm text-gray-400">Awaiting pickup</span>'}
                            </div>
                        </div>

                        <!-- Driver Delivery Images -->
                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-sm font-medium text-gray-700">Driver Delivery</span>
                                <span id="delivery-count-${order.id}" class="text-xs text-gray-500">${(order.images && order.images.delivered) ? (order.images.delivered.length > 0 ? order.images.delivered.length + ' Images' : 'No Images') : 'No Images'}</span>
                            </div>
                            <div id="delivery-images-${order.id}" class="w-full h-48 border-2 border-dashed border-gray-200 rounded-lg flex items-center justify-center">
                                ${(order.images && order.images.delivered && order.images.delivered.length > 0) ? deliveredImagesHtml : '<span class="text-sm text-gray-400">Awaiting delivery</span>'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}


function renderImages(images, stage) {
    if (!images || images.length === 0) return '';

    //  Remove duplicate image URLs before rendering
    const uniqueUrls = [...new Set(images.map(img => img.image_url))].slice(0, 1);

    return uniqueUrls.map(url => `
        <img src="${url}" alt="${capitalizeFirst(stage)} Image"
             class="w-full h-full object-contain rounded-lg border border-gray-200 cursor-pointer hover:shadow-md transition-shadow"
             onclick="openImageModal('${url}', '${capitalizeFirst(stage)} Image', '')" />
    `).join('');
}


// Render progress steps
function renderProgressSteps(currentStatus) {
    const steps = [
        { key: 'pending', label: 'Pending' },
        { key: 'accepted', label: 'Accepted' },
        { key: 'picked_up', label: 'Pickup' },
        { key: 'inTransit', label: 'In Transit' },
        { key: 'delivered', label: 'Delivered' }
    ];
    
    const statusOrder = ['pending', 'accepted', 'picked_up', 'inTransit', 'delivered'];
    const currentIndex = statusOrder.indexOf(currentStatus);
    
    return steps.map((step, index) => {
        const isActive = index <= currentIndex;
        const circleClass = isActive ? 'bg-gradient-to-r from-teal-500 to-cyan-500' : 'bg-gray-200';
        const textClass = isActive ? 'text-gray-900' : 'text-gray-500';
        
        return `
            <div class="flex flex-col items-center">
                <div class="w-4 h-4 rounded-full ${circleClass} mb-1"></div>
                <span class="text-xs font-medium ${textClass}">${step.label}</span>
            </div>
        `;
    }).join('');
}


// Toggle order details visibility
function toggleOrderDetails(orderId) {
   
    
    const details = document.getElementById(`details-${orderId}`);
    const arrow = document.getElementById(`arrow-${orderId}`);
    
    if (!details || !arrow) {
        console.error('Details or arrow element not found for:', orderId);
        return;
    }
    
    if (details.classList.contains('hidden')) {
        
        details.classList.remove('hidden');
        arrow.style.transform = 'rotate(90deg)';
    } else {
        
        details.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
    }
}

// Trigger file upload
function triggerFileUpload(orderNumber) {
    
    
    const uploadInput = document.getElementById(`handover-upload-${orderNumber}`);
    if (uploadInput) {
        
        uploadInput.click();
    } else {
        console.error('Upload input not found for order:', orderNumber);
    }
}

// Handle image upload for pharmacy handover
async function handleImageUpload(event, orderNumber, driverId) {
  
    
    const file = event.target.files[0];
    if (!file || !file.type.startsWith('image/')) {
        console.error('Invalid file selected:', file);
        showError('Please select a valid image file');
        return;
    }

  

    try {
        showLoading(true, 'Uploading image...');
        
        const formData = new FormData();
        formData.append('image', file);
        formData.append('order_number', orderNumber);
        formData.append('pharmacy_id', currentPharmacyId);
        formData.append('pharmacy_name', currentPharmacyName);
        
        // Add driver_id if available
        if (driverId && driverId !== 'null' && driverId !== '') {
            
            formData.append('driver_id', driverId);
        }
        
       
        
        const response = await fetch('/api/upload-handover-image/', {
            method: 'POST',
            body: formData
        });
        
        
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Upload response error:', errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        
        if (data.success) {
           
            showSuccess('Handover image uploaded successfully!');
            // Reload orders to reflect changes
            await loadPharmacyOrders();
        } else {
            console.error('Upload failed:', data.error);
            throw new Error(data.error || 'Upload failed');
        }
        
    } catch (error) {
        console.error('Error uploading image:', error);
        console.error('Error stack:', error.stack);
        showError('Failed to upload image: ' + error.message);
    } finally {
        showLoading(false);
        // Clear the input
        event.target.value = '';
    }
}

// Open image modal
function openImageModal(imageSrc, title, timestamp) {
  
    
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalTitle');
    const modalTimestamp = document.getElementById('modalTimestamp');
    
    if (!modal || !modalImage || !modalTitle || !modalTimestamp) {
        console.error('Modal elements not found');
        return;
    }
    
    modalImage.src = imageSrc;
    modalTitle.textContent = title;
    modalTimestamp.textContent = timestamp;
    modal.classList.remove('hidden');
    
    // Prevent body scroll when modal is open
    document.body.style.overflow = 'hidden';
}

// Close image modal
function closeImageModal() {
   
    
    const modal = document.getElementById('imageModal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
}

// Refresh orders function
async function refreshOrders() {
    
    
    const refreshBtn = event.target.closest('button').querySelector('svg');
    if (refreshBtn) {
        refreshBtn.style.transform = 'rotate(360deg)';
        setTimeout(() => {
            refreshBtn.style.transform = 'rotate(0deg)';
        }, 500);
    }
    
    await loadPharmacyOrders();
}

  // Keep these wrappers and use them consistently
  function formatDate(dateOnly) {
    return formatPlainDate(dateOnly);
  }
  function formatDateTime(utcString) {
    return formatUtcToLocal(utcString, { dateStyle: 'medium', timeStyle: 'short', hour12: true });
  }

function capitalizeFirst(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1).replace('_', ' ');
}

// UI feedback functions
function showLoading(show, message = 'Loading...') {
 
    
    let loader = document.getElementById('loadingOverlay');
    
    if (show) {
        if (!loader) {
            loader = document.createElement('div');
            loader.id = 'loadingOverlay';
            loader.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-teal-600"></div>
                        <span class="text-gray-700">${message}</span>
                    </div>
                </div>
            `;
            document.body.appendChild(loader);
        }
        loader.classList.remove('hidden');
    } else {
        if (loader) {
            loader.classList.add('hidden');
        }
    }
}

function showError(message) {
   
    showNotification(message, 'error');
}

function showSuccess(message) {
   
    showNotification(message, 'success');
}

function showNotification(message, type = 'info') {
    
    
    const notification = document.createElement('div');
    const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
    
    notification.innerHTML = `
        <div class="fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-sm">
            <div class="flex items-center justify-between">
                <span class="text-sm">${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Event listeners
document.addEventListener('click', function(e) {
    // Close modal when clicking outside
    if (e.target && e.target.id === 'imageModal') {
        closeImageModal();
    }
});

document.addEventListener('keydown', function(e) {
    // Close modal with Escape key
    if (e.key === 'Escape') {
        closeImageModal();
    }
});

// Load and display pharmacy details
async function loadPharmacyDetails() {
    try {
        const pharmacyId = getCookie("pharmacyId");
        if (!pharmacyId) {
            console.error("Pharmacy ID not found in cookies");
            return;
        }

        const response = await fetch(`/pharmacy/${pharmacyId}/`);
        if (!response.ok) {
            throw new Error("Failed to fetch pharmacy details");
        }

        const data = await response.json();
        
        if (data.success && data.pharmacy) {
            // Update pharmacy name
            const nameElement = document.getElementById('pharmacyName');
            if (nameElement) {
                nameElement.textContent = data.pharmacy.name;
            }
            
            // Update pharmacy email
            const emailElement = document.getElementById('pharmacyEmail');
            if (emailElement) {
                emailElement.textContent = data.pharmacy.email;
            }
            
            // Update initial (first letter of pharmacy name)
            const initialElement = document.getElementById('pharmacyInitial');
            if (initialElement && data.pharmacy.name) {
                initialElement.textContent = data.pharmacy.name.charAt(0).toUpperCase();
            }
        } else {
            console.error("Invalid pharmacy data received");
        }

    } catch (error) {
        console.error("Error loading pharmacy details:", error);
        showNotification && showNotification('Failed to load pharmacy details', 'error');
    }
}

loadPharmacyDetails();

function logoutPharmacy() {
    // Remove the pharmacyId cookie
    document.cookie = "pharmacyId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

    // Redirect to pharmacy login
    window.location.href = "/pharmacyLogin/";
}


    </script>
</body>
</html>