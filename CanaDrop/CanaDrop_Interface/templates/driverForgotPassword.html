<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forgot Password - CanaLogistiX</title>
  <link rel="icon" href="https://canalogistix.s3.us-east-2.amazonaws.com/Logo/CanaLogistiX_Logo_BG.png">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 to-gray-900 flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <div class="bg-slate-800 rounded-2xl shadow-2xl p-8 backdrop-blur-sm border border-slate-700">
      <!-- Logo / Header -->
      <div class="text-center mb-8">
        <img src="https://canalogistix.s3.us-east-2.amazonaws.com/Logo/CanaLogistiX_Logo_BG.png" alt="CanaLogistiX Logo" class="h-16 w-16 sm:h-20 sm:w-20 rounded-full object-cover mx-auto mb-4"/>
        <h1 class="text-2xl font-bold text-slate-100 mb-2">Forgot Password</h1>
        <p class="text-slate-400">Reset your driver account password in three quick steps</p>
      </div>

      <!-- Step 1: Email -->
      <div id="step-email" class="space-y-4">
        <label class="block text-sm font-medium text-slate-300">Email address</label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <input id="fp-email" type="email" placeholder="you@example.com"
                 class="w-full pl-10 pr-4 py-3 border border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all bg-slate-700 focus:bg-slate-600 text-slate-100 placeholder-slate-400"/>
        </div>
        <button id="btn-send-otp"
                class="w-full bg-gradient-to-r from-slate-700 to-emerald-600 text-white py-3 rounded-lg font-semibold hover:from-slate-600 hover:to-emerald-500 transform hover:scale-[1.01] transition-all shadow">
          Send OTP
        </button>
        <p class="text-sm text-slate-400 text-center mt-2">
        <a href="/driverLogin/" class="text-emerald-400 hover:text-emerald-300 font-medium">Back to Login?</a>
        </p>

      </div>

      <!-- Step 2: OTP -->
      <div id="step-otp" class="space-y-4 hidden">
        <p class="text-sm text-slate-400">
          We sent a 6-digit code to <span id="otp-email-label" class="font-medium text-slate-100"></span>.
        </p>
        <label class="block text-sm font-medium text-slate-300">Enter OTP</label>
        <input id="fp-otp" type="text" inputmode="numeric" maxlength="6" placeholder="••••••"
               class="w-full px-4 py-3 border border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent bg-slate-700 focus:bg-slate-600 text-slate-100 placeholder-slate-500 tracking-widest text-center text-lg"/>
        <div class="flex items-center justify-between text-sm">
          <button id="btn-resend-otp" class="text-emerald-400 hover:text-emerald-300 font-medium">Resend OTP</button>
          <span id="resend-timer" class="text-slate-400"></span>
        </div>
        <button id="btn-verify-otp"
                class="w-full bg-gradient-to-r from-slate-700 to-emerald-600 text-white py-3 rounded-lg font-semibold hover:from-slate-600 hover:to-emerald-500 transform hover:scale-[1.01] transition-all shadow">
          Verify OTP
        </button>

        <p class="text-sm text-slate-400 text-center mt-2">
        <a href="/driverLogin/" class="text-emerald-400 hover:text-emerald-300 font-medium">Back to Login?</a>
        </p>

      </div>

      <!-- Step 3: New Password -->
      <div id="step-reset" class="space-y-4 hidden">
            <div>
              <div class="flex items-center justify-between mb-1">
                <label class="block text-sm font-medium text-slate-300">New Password</label>
                <div class="relative group">
                  <button type="button" class="text-emerald-400 hover:text-emerald-300">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </button>
                  <div class="absolute right-0 bottom-full mb-2 w-64 bg-gray-900 text-white text-xs rounded-lg p-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10 shadow-xl">
                    <div class="font-semibold mb-2">Password Requirements:</div>
                    <ul class="space-y-1 list-disc list-inside">
                      <li>At least 8 characters long</li>
                      <li>Mix of uppercase & lowercase letters</li>
                      <li>Include numbers (0-9)</li>
                      <li>Add special characters (!@#$%^&*)</li>
                    </ul>
                    <div class="absolute top-full right-4 -mt-1">
                      <div class="border-4 border-transparent border-t-gray-900"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="relative">
            <input id="fp-new-pass" type="password" placeholder="New password"
                   class="w-full pr-12 pl-4 py-3 border border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent bg-slate-700 focus:bg-slate-600 text-slate-100 placeholder-slate-400"/>
            <button type="button" id="toggle-new" class="absolute inset-y-0 right-0 pr-3 flex items-center text-emerald-400 hover:text-emerald-300">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M1.5 12S5 4.5 12 4.5 22.5 12 22.5 12 19 19.5 12 19.5 1.5 12 1.5 12Z"/>
                <circle cx="12" cy="12" r="3.25" stroke-width="2"></circle>
              </svg>
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-300">Confirm Password</label>
          <div class="relative">
            <input id="fp-confirm-pass" type="password" placeholder="Confirm password"
                   class="w-full pr-12 pl-4 py-3 border border-slate-600 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent bg-slate-700 focus:bg-slate-600 text-slate-100 placeholder-slate-400"/>
            <button type="button" id="toggle-confirm" class="absolute inset-y-0 right-0 pr-3 flex items-center text-emerald-400 hover:text-emerald-300">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M1.5 12S5 4.5 12 4.5 22.5 12 22.5 12 19 19.5 12 19.5 1.5 12 1.5 12Z"/>
                <circle cx="12" cy="12" r="3.25" stroke-width="2"></circle>
              </svg>
            </button>
          </div>
        </div>

        <button id="btn-change-pass"
                class="w-full bg-gradient-to-r from-slate-700 to-emerald-600 text-white py-3 rounded-lg font-semibold hover:from-slate-600 hover:to-emerald-500 transform hover:scale-[1.01] transition-all shadow">
          Change Password
        </button>

        <p class="text-sm text-slate-400 text-center mt-2">
  <a href="/driverLogin/" class="text-emerald-400 hover:text-emerald-300 font-medium">Back to Login?</a>
</p>

      </div>
    </div>

    <!-- Footer -->
        <div class="text-center mt-8">
        <p class="text-sm text-slate-500">
            © <span id="current-year"></span> CanaLogistiX - Cana Group of Companies. All rights reserved.
        </p>
        </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
    <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 max-w-sm w-full mx-4 relative">
      <button id="closeModalBtn" class="absolute top-4 right-4 text-slate-400 hover:text-slate-300">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <div class="text-center" id="modalContent"></div>
    </div>
  </div>

<script>
  // -------- Dynamic API base (same-origin) --------
  const API_BASE        = window.location.origin;
  const API_SEND_OTP    = new URL('/api/auth/send-otp/', API_BASE).toString();         // shared
  const API_VERIFY_OTP  = new URL('/api/auth/verify-otp/', API_BASE).toString();       // shared
  const API_CHANGE_PASS = new URL('/api/driver/change-password/', API_BASE).toString(); // drivers
  const REDIRECT_URL    = '/driverLogin';
  const RESEND_SECONDS  = 30;

  // -------- State --------
  let currentEmail = '';
  let otpToken = null;
  let resendCountdown = RESEND_SECONDS;
  let timerId = null;
  let weakPasswordAttempts = 0;

  // -------- Elements --------
  const stepEmail   = document.getElementById('step-email');
  const stepOtp     = document.getElementById('step-otp');
  const stepReset   = document.getElementById('step-reset');

  const emailInput  = document.getElementById('fp-email');
  const otpInput    = document.getElementById('fp-otp');
  const newPass     = document.getElementById('fp-new-pass');
  const confirmPass = document.getElementById('fp-confirm-pass');

  const btnSendOtp    = document.getElementById('btn-send-otp');
  const btnVerifyOtp  = document.getElementById('btn-verify-otp');
  const btnResendOtp  = document.getElementById('btn-resend-otp');
  const resendTimerEl = document.getElementById('resend-timer');
  const btnChangePass = document.getElementById('btn-change-pass');

  const otpEmailLabel = document.getElementById('otp-email-label');

  // Modal
  const modal         = document.getElementById('modal');
  const modalContent  = document.getElementById('modalContent');
  const closeModalBtn = document.getElementById('closeModalBtn');

  // -------- Helpers --------
  function setLoading(button, isLoading, textWhenIdle) {
    if (isLoading) {
      button.disabled = true;
      button.classList.add('opacity-80', 'cursor-not-allowed');
      button.textContent = 'Please wait...';
    } else {
      button.disabled = false;
      button.classList.remove('opacity-80', 'cursor-not-allowed');
      button.textContent = textWhenIdle;
    }
  }

      function getCSRFToken() {
    return document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
      }

function show(section) {
  [stepEmail, stepOtp, stepReset].forEach(s => s.classList.add('hidden'));
  section.classList.remove('hidden');
  
  // Reset weak password attempts when leaving reset step
  if (section !== stepReset) {
    weakPasswordAttempts = 0;
  }
}

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function normalizeEmail(email) {
    return email.trim().toLowerCase();
  }

  function showModal(status, title, message) {
    const iconSuccess = `
      <svg class="h-16 w-16 text-emerald-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>`;
    const iconFail = `
      <svg class="h-16 w-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>`;
    modalContent.innerHTML = `
      ${status === 'success' ? iconSuccess : iconFail}
      <h3 class="text-xl font-bold text-slate-100 mb-2">${title}</h3>
      <p class="text-slate-300 mb-4">${message || ''}</p>
      <button id="modalAction" class="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition-colors">
        Continue
      </button>
    `;
    modal.classList.remove('hidden');

    document.getElementById('modalAction').onclick = () => {
      modal.classList.add('hidden');
      window.location.href = REDIRECT_URL; // redirect after closing
    };
  }

  function showWarningModal(title, message, callback) {
  const iconWarning = `
    <svg class="h-16 w-16 text-amber-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
    </svg>`;
  
  modalContent.innerHTML = `
    ${iconWarning}
    <h3 class="text-xl font-bold text-slate-100 mb-2">${title}</h3>
    <p class="text-slate-300 mb-4 whitespace-pre-line">${message}</p>
    <button id="modalWarningAction" class="bg-amber-600 text-white px-6 py-2 rounded-lg hover:bg-amber-700 transition-colors">
      OK
    </button>
  `;
  modal.classList.remove('hidden');

  document.getElementById('modalWarningAction').onclick = () => {
    modal.classList.add('hidden');
    if (callback) callback();
  };
}

closeModalBtn.addEventListener('click', () => {
  modal.classList.add('hidden');
  // Only redirect if the modal was a success/fail modal that should redirect
  const modalAction = document.getElementById('modalAction');
  if (modalAction) {
    window.location.href = REDIRECT_URL;
  }
});

  // Force digits-only OTP and max length 6
  otpInput?.addEventListener('input', () => {
    otpInput.value = otpInput.value.replace(/\D/g, '').slice(0, 6);
  });

  // Force lowercase in email input
  emailInput.addEventListener('input', e => e.target.value = e.target.value.toLowerCase());

  // -------- Resend timer --------
  function startResendTimer() {
    resendCountdown = RESEND_SECONDS;
    resendTimerEl.textContent = `You can resend in ${resendCountdown}s`;
    btnResendOtp.classList.add('pointer-events-none', 'opacity-50');

    timerId = setInterval(() => {
      resendCountdown--;
      if (resendCountdown <= 0) {
        clearInterval(timerId);
        resendTimerEl.textContent = '';
        btnResendOtp.classList.remove('pointer-events-none', 'opacity-50');
      } else {
        resendTimerEl.textContent = `You can resend in ${resendCountdown}s`;
      }
    }, 1000);
  }

  // -------- Events --------
  btnSendOtp.addEventListener('click', async () => {
    const rawEmail = emailInput.value.trim();
    if (!rawEmail || !isValidEmail(rawEmail)) {
      return showWarningModal('Invalid Email', 'Please enter a valid email address.');
    }
    const email = normalizeEmail(rawEmail);

    setLoading(btnSendOtp, true, 'Send OTP');
    try {
      const res = await fetch(API_SEND_OTP, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const data = await res.json();

      if (data.success) {
        currentEmail = email;
        otpEmailLabel.textContent = currentEmail;
        show(stepOtp);
        startResendTimer();
      } else {
        showModal('fail', 'Failed to Send OTP', data.message || 'Please try again.');
      }
    } catch (e) {
      console.error('Send OTP error:', e);
      showModal('fail', 'Network Error', 'Could not send OTP. Please try again.');
    } finally {
      setLoading(btnSendOtp, false, 'Send OTP');
    }
  });

  btnResendOtp.addEventListener('click', async () => {
    if (!currentEmail) return;
    const email = normalizeEmail(currentEmail);
    setLoading(btnResendOtp, true, 'Resend OTP');
    try {
      const res = await fetch(API_SEND_OTP, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if (data.success) {
        startResendTimer();
      } else {
        showModal('fail', 'Failed to Resend OTP', data.message || 'Please try again.');
      }
    } catch (e) {
      console.error('Resend OTP error:', e);
      showModal('fail', 'Network Error', 'Could not resend OTP.');
    } finally {
      setLoading(btnResendOtp, false, 'Resend OTP');
    }
  });

  btnVerifyOtp.addEventListener('click', async () => {
    const otp = otpInput.value.trim();
    if (otp.length < 4) {
      return showWarningModal('Invalid OTP', 'Please enter the code sent to your email.');
    }
    const email = normalizeEmail(currentEmail);

    setLoading(btnVerifyOtp, true, 'Verify OTP');
    try {
      const res = await fetch(API_VERIFY_OTP, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, otp })
      });
      const data = await res.json();

      if (data.success) {
        otpToken = data.token || null;
        show(stepReset);
        setTimeout(() => document.getElementById('fp-new-pass').focus(), 50);
      } else {
        showModal('fail', 'OTP Verification Failed', data.message || 'The code is incorrect or expired.');
      }
    } catch (e) {
      console.error('Verify OTP error:', e);
      showModal('fail', 'Network Error', 'Could not verify OTP.');
    } finally {
      setLoading(btnVerifyOtp, false, 'Verify OTP');
    }
  });

  btnChangePass.addEventListener('click', async () => {
    const p1 = newPass.value.trim();
    const p2 = confirmPass.value.trim();

    if (!p1 || !p2) {
      return showWarningModal(
        'Missing Fields',
        'Please enter and confirm your new password.'
      );
    }
    if (p1 !== p2) {
      return showWarningModal(
        'Password Mismatch',
        'New Password and Confirm Password must match.'
      );
    }
    if (p1.length < 8) {
      weakPasswordAttempts++;
      const remainingAttempts = 3 - weakPasswordAttempts;

      if (weakPasswordAttempts >= 3) {
        showModal(
          'fail',
          'Too Many Attempts',
          'You have exceeded the maximum number of attempts. Please restart the password reset process.'
        );
        return;
      }

      showWarningModal(
        'Weak Password',
        `Please use at least 8 characters.\n\nAttempts remaining: ${remainingAttempts}`
      );
      return;
    }

    // Add password strength validation
    const hasUpperCase = /[A-Z]/.test(p1);
    const hasLowerCase = /[a-z]/.test(p1);
    const hasNumber = /[0-9]/.test(p1);
    const hasSpecialChar = /[!@#$%^&*(),.?":{}|<>]/.test(p1);

    if (!hasUpperCase || !hasLowerCase || !hasNumber || !hasSpecialChar) {
      weakPasswordAttempts++;
      const remainingAttempts = 3 - weakPasswordAttempts;

      const missing = [];
      if (!hasUpperCase) missing.push('uppercase letter');
      if (!hasLowerCase) missing.push('lowercase letter');
      if (!hasNumber) missing.push('number');
      if (!hasSpecialChar) missing.push('special character');

      if (weakPasswordAttempts >= 3) {
        showModal(
          'fail',
          'Too Many Attempts',
          'You have exceeded the maximum number of attempts. Please restart the password reset process.'
        );
        return;
      }

      showWarningModal(
        'Weak Password',
        `Password must include: ${missing.join(', ')}.\n\nAttempts remaining: ${remainingAttempts}`
      );
      return;
    }

    const email = normalizeEmail(currentEmail);
    setLoading(btnChangePass, true, 'Change Password');
    try {
      const payload = { email, newPassword: p1, confirmPassword: p2 };
      if (otpToken) payload.otpToken = otpToken;

      const csrfToken = getCSRFToken(); // ✅ use your existing function

      const res = await fetch(API_CHANGE_PASS, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken // ✅ what Django csrf_protect expects
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (data.success) {
        // Reset counter on success
        weakPasswordAttempts = 0;
        showModal('success', 'Password Changed', data.message || 'Your password has been updated.');
      } else {
        // Check if it's a password strength issue from the server
        if (data.message && data.message.toLowerCase().includes('password')) {
          weakPasswordAttempts++;
          const remainingAttempts = 3 - weakPasswordAttempts;

          if (weakPasswordAttempts >= 3) {
            showModal(
              'fail',
              'Too Many Attempts',
              'You have exceeded the maximum number of attempts. Please restart the password reset process.'
            );
            return;
          }

          showWarningModal(
            'Password Requirements Not Met',
            `${data.message}\n\nAttempts remaining: ${remainingAttempts}`
          );
        } else {
          showModal(
            'fail',
            'Change Failed',
            data.message || 'Please try again.'
          );
        }
      }
    } catch (e) {
      console.error('Change Password error:', e);
      showModal('fail', 'Network Error', 'Could not change password.');
    } finally {
      setLoading(btnChangePass, false, 'Change Password');
    }
  });


  // Toggle visibility
  const toggleNew = document.getElementById('toggle-new');
  const toggleConfirm = document.getElementById('toggle-confirm');
  let showNew = false, showConfirm = false;

  toggleNew.addEventListener('click', () => {
    showNew = !showNew;
    newPass.type = showNew ? 'text' : 'password';
  });
  toggleConfirm.addEventListener('click', () => {
    showConfirm = !showConfirm;
    confirmPass.type = showConfirm ? 'text' : 'password';
  });

  document.getElementById("current-year").textContent = new Date().getFullYear();
</script>

</body>
</html>
